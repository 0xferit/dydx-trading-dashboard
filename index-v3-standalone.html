<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dYdX Analytics v3.0.0</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="breadcrumb">ANALYTICS / OVERVIEW</div>
            <div class="header-right">
                <span class="status-badge live">LIVE</span>
                <div class="address mono" id="addressDisplay">Not Connected</div>
            </div>
        </div>

        <!-- Address Input Section -->
        <div style="background: var(--bg-secondary); padding: 20px; margin-bottom: 24px;">
            <div style="display: flex; gap: 16px; align-items: center;">
                <input type="text" 
                       id="addressInput" 
                       placeholder="Enter dYdX address (e.g., dydx1...)" 
                       value="dydx1agxtmjdgw7nrgs7m086m3qse7hwyf54gfeampv"
                       style="flex: 1; background: var(--bg-elevated); border: 1px solid var(--border); 
                              color: var(--text-primary); padding: 12px; font-family: 'JetBrains Mono', monospace;">
                <button id="loadDashboard" 
                        onclick="loadDashboard()"
                        style="padding: 12px 24px; background: var(--text-primary); color: var(--bg-primary);
                               border: none; cursor: pointer; font-weight: 600; text-transform: uppercase;">
                    Load Dashboard
                </button>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="overview">OVERVIEW</div>
            <div class="nav-tab" data-tab="performance">PERFORMANCE</div>
            <div class="nav-tab" data-tab="risk">RISK ANALYSIS</div>
            <div class="nav-tab" data-tab="positions">POSITIONS</div>
            <div class="nav-tab" data-tab="behavior">BEHAVIOR</div>
            <div class="nav-tab" data-tab="market">MARKET STRUCTURE</div>
        </div>

        <!-- Loading State -->
        <div id="loader" class="loading" style="display: none;">
            <div class="spinner"></div>
            <div style="margin-top: 16px;">Loading portfolio data...</div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <!-- Overview Tab -->
        <div class="tab-content active" id="overview">
            <!-- Primary Metrics -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Total P&L</div>
                    <div class="metric-value mono" id="totalPnL">-</div>
                    <div class="metric-change mono" id="totalPnLChange">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Win Rate</div>
                    <div class="metric-value mono" id="winRate">-</div>
                    <div class="metric-change mono" id="winRateDetail">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Profit Factor</div>
                    <div class="metric-value mono" id="profitFactor">-</div>
                    <div class="metric-change mono" id="profitFactorDetail">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Sharpe Ratio</div>
                    <div class="metric-value mono" id="sharpeRatio">-</div>
                    <div class="metric-change mono">30-day rolling</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Sortino Ratio</div>
                    <div class="metric-value mono" id="sortinoRatio">-</div>
                    <div class="metric-change mono">Downside focus</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Max Drawdown</div>
                    <div class="metric-value mono" id="maxDrawdown">-</div>
                    <div class="metric-change mono" id="maxDrawdownDate">-</div>
                </div>
            </div>

            <!-- Positions Summary -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Account Summary</div>
                </div>
                <table>
                    <tr>
                        <td style="color: var(--text-secondary)">Equity</td>
                        <td class="mono" id="equity">-</td>
                    </tr>
                    <tr>
                        <td style="color: var(--text-secondary)">Free Collateral</td>
                        <td class="mono" id="freeCollateral">-</td>
                    </tr>
                    <tr>
                        <td style="color: var(--text-secondary)">Margin Usage</td>
                        <td class="mono" id="marginUsage">-</td>
                    </tr>
                    <tr>
                        <td style="color: var(--text-secondary)">Open Positions</td>
                        <td class="mono" id="openPositions">-</td>
                    </tr>
                    <tr>
                        <td style="color: var(--text-secondary)">Total Volume</td>
                        <td class="mono" id="totalVolume">-</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Performance Tab -->
        <div class="tab-content" id="performance">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Total Trades</div>
                    <div class="metric-value mono" id="totalTrades">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Winning Trades</div>
                    <div class="metric-value mono profit" id="winningTrades">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Losing Trades</div>
                    <div class="metric-value mono loss" id="losingTrades">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Average Win</div>
                    <div class="metric-value mono" id="avgWin">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Average Loss</div>
                    <div class="metric-value mono" id="avgLoss">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Best Trade</div>
                    <div class="metric-value mono profit" id="bestTrade">-</div>
                </div>
            </div>
        </div>

        <!-- Risk Tab -->
        <div class="tab-content" id="risk">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Current Leverage</div>
                    <div class="metric-value mono" id="leverage">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Value at Risk (95%)</div>
                    <div class="metric-value mono" id="var95">-</div>
                    <div class="metric-change mono">Daily VaR</div>
                </div>
            </div>
        </div>

        <!-- Positions Tab -->
        <div class="tab-content" id="positions">
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Open Positions</div>
                </div>
                <table id="positionsTable">
                    <thead>
                        <tr>
                            <th>MARKET</th>
                            <th>SIDE</th>
                            <th>SIZE</th>
                            <th>ENTRY PRICE</th>
                            <th>UNREALIZED P&L</th>
                        </tr>
                    </thead>
                    <tbody id="positionsTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; color: var(--text-secondary);">
                                No positions loaded
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Command Palette Hint -->
        <div class="cmd-hint">
            Press <span class="key">âŒ˜</span><span class="key">K</span> for commands
        </div>
    </div>

    <script>
        // Configuration
        const DYDX_API = 'https://indexer.dydx.trade/v4';
        let currentAddress = null;
        let currentData = null;

        // Tab navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                const tabId = this.dataset.tab;
                document.getElementById(tabId)?.classList.add('active');
            });
        });

        // Format functions
        function formatCurrency(value) {
            if (value === null || value === undefined || isNaN(value)) return '-';
            const sign = value >= 0 ? '+' : '';
            return sign + '$' + Math.abs(value).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function formatNumber(value, decimals = 2) {
            if (value === null || value === undefined || isNaN(value)) return '-';
            return value.toFixed(decimals);
        }

        function formatPercent(value) {
            if (value === null || value === undefined || isNaN(value)) return '-';
            return value.toFixed(2) + '%';
        }

        // Load dashboard
        async function loadDashboard() {
            const address = document.getElementById('addressInput').value.trim();
            if (!address) {
                showError('Please enter a valid dYdX address');
                return;
            }

            currentAddress = address;
            showLoading(true);
            hideError();

            try {
                // Update address display
                document.getElementById('addressDisplay').textContent = 
                    address.slice(0, 8) + '...' + address.slice(-4);

                // Fetch account data
                const accountResponse = await fetch(`${DYDX_API}/addresses/${address}/subaccountNumber/0`);
                if (!accountResponse.ok) throw new Error('Failed to fetch account data');
                const accountData = await accountResponse.json();

                // Fetch positions
                const positionsResponse = await fetch(`${DYDX_API}/perpetualPositions?address=${address}&subaccountNumber=0`);
                const positionsData = await positionsResponse.json();

                // Fetch fills (trades)
                const fillsResponse = await fetch(`${DYDX_API}/fills?address=${address}&subaccountNumber=0&limit=100`);
                const fillsData = await fillsResponse.json();

                // Process and display data
                processAccountData(accountData, positionsData, fillsData);

                showLoading(false);
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showError('Failed to load data: ' + error.message);
                showLoading(false);
            }
        }

        // Process account data
        function processAccountData(accountData, positionsData, fillsData) {
            const subaccount = accountData.subaccount || {};
            const positions = positionsData.positions || [];
            const fills = fillsData.fills || [];

            // Update account summary
            document.getElementById('equity').textContent = 
                formatCurrency(parseFloat(subaccount.equity || 0));
            document.getElementById('freeCollateral').textContent = 
                formatCurrency(parseFloat(subaccount.freeCollateral || 0));
            document.getElementById('marginUsage').textContent = 
                formatPercent(parseFloat(subaccount.marginUsage || 0) * 100);
            
            // Count open positions
            const openPositions = positions.filter(p => p.status === 'OPEN').length;
            document.getElementById('openPositions').textContent = openPositions;

            // Calculate leverage
            const equity = parseFloat(subaccount.equity || 0);
            const notionalValue = positions.reduce((sum, p) => {
                return sum + Math.abs(parseFloat(p.size || 0) * parseFloat(p.entryPrice || 0));
            }, 0);
            const leverage = equity > 0 ? notionalValue / equity : 0;
            document.getElementById('leverage').textContent = formatNumber(leverage, 1) + 'x';

            // Process trades
            processTradesData(fills);

            // Update positions table
            updatePositionsTable(positions);

            // Calculate metrics
            calculateMetrics(positions, fills);
        }

        // Process trades data
        function processTradesData(fills) {
            let totalPnL = 0;
            let wins = 0;
            let losses = 0;
            let totalWinAmount = 0;
            let totalLossAmount = 0;

            fills.forEach(fill => {
                const pnl = parseFloat(fill.realizedPnl || 0);
                totalPnL += pnl;
                
                if (pnl > 0) {
                    wins++;
                    totalWinAmount += pnl;
                } else if (pnl < 0) {
                    losses++;
                    totalLossAmount += Math.abs(pnl);
                }
            });

            const totalTrades = wins + losses;
            const winRate = totalTrades > 0 ? (wins / totalTrades) * 100 : 0;
            const avgWin = wins > 0 ? totalWinAmount / wins : 0;
            const avgLoss = losses > 0 ? totalLossAmount / losses : 0;
            const profitFactor = totalLossAmount > 0 ? totalWinAmount / totalLossAmount : 0;

            // Update UI
            document.getElementById('totalPnL').textContent = formatCurrency(totalPnL);
            document.getElementById('winRate').textContent = formatPercent(winRate);
            document.getElementById('winRateDetail').textContent = `${wins} / ${totalTrades} trades`;
            document.getElementById('profitFactor').textContent = formatNumber(profitFactor);
            document.getElementById('totalTrades').textContent = totalTrades;
            document.getElementById('winningTrades').textContent = wins;
            document.getElementById('losingTrades').textContent = losses;
            document.getElementById('avgWin').textContent = formatCurrency(avgWin);
            document.getElementById('avgLoss').textContent = formatCurrency(avgLoss);

            // Add color classes
            if (totalPnL > 0) {
                document.getElementById('totalPnL').classList.add('profit');
            } else if (totalPnL < 0) {
                document.getElementById('totalPnL').classList.add('loss');
            }
        }

        // Update positions table
        function updatePositionsTable(positions) {
            const tbody = document.getElementById('positionsTableBody');
            
            const openPositions = positions.filter(p => p.status === 'OPEN');
            
            if (openPositions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: var(--text-secondary);">
                            No open positions
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = openPositions.map(position => {
                const unrealizedPnl = parseFloat(position.unrealizedPnl || 0);
                const pnlClass = unrealizedPnl > 0 ? 'profit' : unrealizedPnl < 0 ? 'loss' : '';
                
                return `
                    <tr>
                        <td>${position.market}</td>
                        <td class="${position.side === 'LONG' ? 'profit' : 'loss'}">${position.side}</td>
                        <td class="mono">${formatNumber(Math.abs(parseFloat(position.size || 0)))}</td>
                        <td class="mono">${formatCurrency(parseFloat(position.entryPrice || 0))}</td>
                        <td class="mono ${pnlClass}">${formatCurrency(unrealizedPnl)}</td>
                    </tr>
                `;
            }).join('');
        }

        // Calculate advanced metrics (simplified)
        function calculateMetrics(positions, fills) {
            // Simplified Sharpe ratio (would need returns history)
            document.getElementById('sharpeRatio').textContent = '-';
            document.getElementById('sortinoRatio').textContent = '-';
            
            // Calculate max drawdown (simplified)
            let runningPnL = 0;
            let peak = 0;
            let maxDrawdown = 0;

            fills.forEach(fill => {
                runningPnL += parseFloat(fill.realizedPnl || 0);
                if (runningPnL > peak) {
                    peak = runningPnL;
                }
                const drawdown = peak - runningPnL;
                if (drawdown > maxDrawdown) {
                    maxDrawdown = drawdown;
                }
            });

            const maxDrawdownPct = peak > 0 ? (maxDrawdown / peak) * 100 : 0;
            document.getElementById('maxDrawdown').textContent = formatPercent(maxDrawdownPct);
        }

        // Show/hide loading
        function showLoading(show) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
        }

        // Show error
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        // Hide error
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Check for address in URL on load
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const address = urlParams.get('address');
            
            if (address) {
                document.getElementById('addressInput').value = address;
                loadDashboard();
            }
        });

        // Enter key to load
        document.getElementById('addressInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadDashboard();
            }
        });
    </script>
</body>
</html>