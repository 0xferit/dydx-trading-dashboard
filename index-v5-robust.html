<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dYdX Analytics v5.0.0 - Robust</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Data status indicators */
        .data-status {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            padding: 12px;
            border-radius: 4px;
            max-width: 300px;
            z-index: 1000;
            font-size: 12px;
        }
        
        .data-status-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 0;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
            display: inline-block;
        }
        
        .status-dot.success { background: var(--profit); }
        .status-dot.loading { background: var(--warning); animation: pulse 1s infinite; }
        .status-dot.error { background: var(--loss); }
        .status-dot.partial { background: var(--warning); }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .data-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            padding: 12px;
            margin: 16px 0;
            border-radius: 4px;
            font-size: 13px;
            display: none;
        }
        
        .data-warning.show { display: block; }
        
        .data-warning-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--warning);
        }
        
        .data-warning-list {
            margin: 0;
            padding-left: 20px;
        }
        
        .metric-card.incomplete {
            opacity: 0.5;
            position: relative;
        }
        
        .metric-card.incomplete::after {
            content: '⚠';
            position: absolute;
            top: 8px;
            right: 8px;
            color: var(--warning);
            font-size: 16px;
        }
        
        .table-container.no-data {
            opacity: 0.5;
        }
        
        .retry-button {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 8px;
        }
        
        .retry-button:hover {
            background: var(--bg-secondary);
        }
        
        .inline-error {
            color: var(--loss);
            font-size: 11px;
            font-style: italic;
        }
        
        .status-summary {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-elevated);
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            display: none;
            z-index: 1001;
        }
        
        .status-summary.show { display: block; }
        .status-summary.all-good { border: 1px solid var(--profit); color: var(--profit); }
        .status-summary.partial { border: 1px solid var(--warning); color: var(--warning); }
        .status-summary.error { border: 1px solid var(--loss); color: var(--loss); }
    </style>
</head>
<body>
    <div class="container">
        <!-- Status Summary -->
        <div id="statusSummary" class="status-summary"></div>
        
        <!-- Header -->
        <div class="header">
            <div class="breadcrumb">ANALYTICS / OVERVIEW</div>
            <div class="header-right">
                <span class="status-badge live">LIVE</span>
                <div class="address mono" id="addressDisplay">Not Connected</div>
            </div>
        </div>

        <!-- Address Input Section -->
        <div style="background: var(--bg-secondary); padding: 20px; margin-bottom: 24px;">
            <div style="display: flex; gap: 16px; align-items: center;">
                <input type="text" 
                       id="addressInput" 
                       placeholder="Enter dYdX address (e.g., dydx1...)" 
                       value="dydx1agxtmjdgw7nrgs7m086m3qse7hwyf54gfeampv"
                       style="flex: 1; background: var(--bg-elevated); border: 1px solid var(--border); 
                              color: var(--text-primary); padding: 12px; font-family: 'JetBrains Mono', monospace;">
                <button id="loadDashboard" 
                        onclick="loadDashboard()"
                        style="padding: 12px 24px; background: var(--text-primary); color: var(--bg-primary);
                               border: none; cursor: pointer; font-weight: 600; text-transform: uppercase;">
                    Load Dashboard
                </button>
                <button onclick="toggleDataStatus()" 
                        style="padding: 12px; background: var(--bg-elevated); color: var(--text-secondary);
                               border: 1px solid var(--border); cursor: pointer;">
                    Status
                </button>
            </div>
        </div>

        <!-- Data Warning -->
        <div id="dataWarning" class="data-warning">
            <div class="data-warning-title">⚠ Incomplete Data</div>
            <div>Some data sources failed to load. The displayed metrics may be incomplete:</div>
            <ul class="data-warning-list" id="warningList"></ul>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="overview">OVERVIEW</div>
            <div class="nav-tab" data-tab="positions">POSITIONS</div>
            <div class="nav-tab" data-tab="orders">ORDERS</div>
            <div class="nav-tab" data-tab="fills">FILLS</div>
            <div class="nav-tab" data-tab="transfers">TRANSFERS</div>
            <div class="nav-tab" data-tab="pnl">HISTORICAL P&L</div>
        </div>

        <!-- Loading State -->
        <div id="loader" class="loading" style="display: none;">
            <div class="spinner"></div>
            <div style="margin-top: 16px;">Loading portfolio data...</div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <!-- Overview Tab -->
        <div class="tab-content active" id="overview">
            <!-- Primary Metrics -->
            <div class="metrics-grid">
                <div class="metric-card" data-source="subaccount">
                    <div class="metric-label">Equity</div>
                    <div class="metric-value mono" id="equity">-</div>
                    <div class="metric-change mono">Total Value</div>
                </div>
                <div class="metric-card" data-source="subaccount">
                    <div class="metric-label">Free Collateral</div>
                    <div class="metric-value mono" id="freeCollateral">-</div>
                    <div class="metric-change mono">Available</div>
                </div>
                <div class="metric-card" data-source="subaccount">
                    <div class="metric-label">Margin Usage</div>
                    <div class="metric-value mono" id="marginUsage">-</div>
                    <div class="metric-change mono">Utilization</div>
                </div>
                <div class="metric-card" data-source="subaccount">
                    <div class="metric-label">Leverage</div>
                    <div class="metric-value mono" id="leverage">-</div>
                    <div class="metric-change mono">Current</div>
                </div>
                <div class="metric-card" data-source="positions">
                    <div class="metric-label">Open Positions</div>
                    <div class="metric-value mono" id="openPositions">-</div>
                    <div class="metric-change mono">Active</div>
                </div>
                <div class="metric-card" data-source="positions">
                    <div class="metric-label">Total P&L</div>
                    <div class="metric-value mono" id="totalPnL">-</div>
                    <div class="metric-change mono">All Time</div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="two-column">
                <div class="table-container" data-source="positions">
                    <div class="table-header">
                        <div class="table-title">Trading Statistics</div>
                    </div>
                    <table>
                        <tr>
                            <td style="color: var(--text-secondary)">Total Trades</td>
                            <td class="mono" id="totalTrades">-</td>
                        </tr>
                        <tr>
                            <td style="color: var(--text-secondary)">Win Rate</td>
                            <td class="mono" id="winRate">-</td>
                        </tr>
                        <tr>
                            <td style="color: var(--text-secondary)">Average Win</td>
                            <td class="mono" id="avgWin">-</td>
                        </tr>
                        <tr>
                            <td style="color: var(--text-secondary)">Average Loss</td>
                            <td class="mono" id="avgLoss">-</td>
                        </tr>
                        <tr>
                            <td style="color: var(--text-secondary)">Profit Factor</td>
                            <td class="mono" id="profitFactor">-</td>
                        </tr>
                    </table>
                </div>

                <div class="table-container" data-source="subaccount">
                    <div class="table-header">
                        <div class="table-title">Account Details</div>
                    </div>
                    <table>
                        <tr>
                            <td style="color: var(--text-secondary)">Quote Balance</td>
                            <td class="mono" id="quoteBalance">-</td>
                        </tr>
                        <tr>
                            <td style="color: var(--text-secondary)">Pending Deposits</td>
                            <td class="mono" id="pendingDeposits">-</td>
                        </tr>
                        <tr>
                            <td style="color: var(--text-secondary)">Pending Withdrawals</td>
                            <td class="mono" id="pendingWithdrawals">-</td>
                        </tr>
                        <tr>
                            <td style="color: var(--text-secondary)">Created At</td>
                            <td class="mono" id="createdAt">-</td>
                        </tr>
                        <tr>
                            <td style="color: var(--text-secondary)">Updated At</td>
                            <td class="mono" id="updatedAt">-</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Other tabs remain the same structure -->
        <div class="tab-content" id="positions">
            <div class="table-container" data-source="positions">
                <div class="table-header">
                    <div class="table-title">Perpetual Positions</div>
                    <span id="positionsError" class="inline-error"></span>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>MARKET</th>
                            <th>STATUS</th>
                            <th>SIDE</th>
                            <th>SIZE</th>
                            <th>ENTRY PRICE</th>
                            <th>EXIT PRICE</th>
                            <th>REALIZED P&L</th>
                            <th>UNREALIZED P&L</th>
                            <th>CREATED</th>
                        </tr>
                    </thead>
                    <tbody id="positionsTableBody">
                        <tr><td colspan="9" style="text-align: center;">No data loaded</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-content" id="orders">
            <div class="table-container" data-source="orders">
                <div class="table-header">
                    <div class="table-title">Orders</div>
                    <span id="ordersError" class="inline-error"></span>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>TIME</th>
                            <th>MARKET</th>
                            <th>SIDE</th>
                            <th>TYPE</th>
                            <th>SIZE</th>
                            <th>PRICE</th>
                            <th>STATUS</th>
                            <th>FILLED</th>
                            <th>REMAINING</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        <tr><td colspan="9" style="text-align: center;">No data loaded</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-content" id="fills">
            <div class="table-container" data-source="fills">
                <div class="table-header">
                    <div class="table-title">Fills (Executed Trades)</div>
                    <span id="fillsError" class="inline-error"></span>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>TIME</th>
                            <th>MARKET</th>
                            <th>SIDE</th>
                            <th>TYPE</th>
                            <th>SIZE</th>
                            <th>PRICE</th>
                            <th>FEE</th>
                            <th>LIQUIDITY</th>
                            <th>ORDER ID</th>
                        </tr>
                    </thead>
                    <tbody id="fillsTableBody">
                        <tr><td colspan="9" style="text-align: center;">No data loaded</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-content" id="transfers">
            <div class="table-container" data-source="transfers">
                <div class="table-header">
                    <div class="table-title">Transfers</div>
                    <span id="transfersError" class="inline-error"></span>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>TIME</th>
                            <th>TYPE</th>
                            <th>AMOUNT</th>
                            <th>FROM</th>
                            <th>TO</th>
                            <th>TX HASH</th>
                        </tr>
                    </thead>
                    <tbody id="transfersTableBody">
                        <tr><td colspan="6" style="text-align: center;">No data loaded</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-content" id="pnl">
            <div class="table-container" data-source="historicalPnl">
                <div class="table-header">
                    <div class="table-title">Historical P&L</div>
                    <span id="pnlError" class="inline-error"></span>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>DATE</th>
                            <th>EQUITY</th>
                            <th>TOTAL P&L</th>
                            <th>NET TRANSFERS</th>
                            <th>CREATED AT</th>
                        </tr>
                    </thead>
                    <tbody id="pnlTableBody">
                        <tr><td colspan="5" style="text-align: center;">No data loaded</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Data Status Panel -->
    <div id="dataStatus" class="data-status" style="display: none;">
        <div style="font-weight: bold; margin-bottom: 8px;">Data Sources</div>
        <div id="statusList"></div>
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
            <button onclick="retryFailed()" class="retry-button" style="width: 100%;">Retry Failed</button>
        </div>
    </div>

    <script>
        // Configuration
        const DYDX_API = 'https://indexer.dydx.trade/v4';
        let currentAddress = null;
        let allData = {};
        let dataStatus = {
            subaccount: { status: 'idle', error: null, data: null },
            positions: { status: 'idle', error: null, data: null },
            orders: { status: 'idle', error: null, data: null },
            fills: { status: 'idle', error: null, data: null },
            transfers: { status: 'idle', error: null, data: null },
            historicalPnl: { status: 'idle', error: null, data: null }
        };

        // Tab navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                const tabId = this.dataset.tab;
                document.getElementById(tabId)?.classList.add('active');
            });
        });

        // Toggle data status panel
        function toggleDataStatus() {
            const panel = document.getElementById('dataStatus');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // Update status display
        function updateStatusDisplay() {
            const statusList = document.getElementById('statusList');
            const warningList = document.getElementById('warningList');
            const statusSummary = document.getElementById('statusSummary');
            
            let html = '';
            let warnings = [];
            let failedCount = 0;
            let successCount = 0;
            
            const endpoints = {
                subaccount: 'Account Data',
                positions: 'Positions',
                orders: 'Orders',
                fills: 'Fills',
                transfers: 'Transfers',
                historicalPnl: 'Historical P&L'
            };
            
            for (const [key, label] of Object.entries(endpoints)) {
                const status = dataStatus[key];
                let statusClass = status.status;
                let statusText = status.status;
                
                if (status.status === 'error') {
                    failedCount++;
                    warnings.push(`${label}: ${status.error || 'Failed to load'}`);
                    statusText = 'Failed';
                } else if (status.status === 'success') {
                    successCount++;
                    statusText = 'Loaded';
                }
                
                html += `
                    <div class="data-status-item">
                        <span><span class="status-dot ${statusClass}"></span>${label}</span>
                        <span>${statusText}</span>
                    </div>
                `;
            }
            
            statusList.innerHTML = html;
            
            // Update warnings
            if (warnings.length > 0) {
                document.getElementById('dataWarning').classList.add('show');
                warningList.innerHTML = warnings.map(w => `<li>${w}</li>`).join('');
                
                // Update affected UI elements
                document.querySelectorAll('[data-source]').forEach(el => {
                    const source = el.dataset.source;
                    if (dataStatus[source]?.status === 'error') {
                        el.classList.add('incomplete');
                        if (el.classList.contains('table-container')) {
                            el.classList.add('no-data');
                        }
                    } else {
                        el.classList.remove('incomplete', 'no-data');
                    }
                });
                
                // Show summary
                if (failedCount === 6) {
                    statusSummary.textContent = '❌ All data sources failed';
                    statusSummary.className = 'status-summary show error';
                } else {
                    statusSummary.textContent = `⚠ ${failedCount} of 6 data sources failed`;
                    statusSummary.className = 'status-summary show partial';
                }
            } else {
                document.getElementById('dataWarning').classList.remove('show');
                document.querySelectorAll('[data-source]').forEach(el => {
                    el.classList.remove('incomplete', 'no-data');
                });
                
                if (successCount === 6) {
                    statusSummary.textContent = '✓ All data loaded successfully';
                    statusSummary.className = 'status-summary show all-good';
                    setTimeout(() => {
                        statusSummary.classList.remove('show');
                    }, 3000);
                }
            }
        }

        // Format functions
        function formatCurrency(value) {
            if (value === null || value === undefined || isNaN(value)) return '-';
            const absValue = Math.abs(value);
            const sign = value >= 0 ? '+' : '-';
            
            if (absValue >= 1000000) {
                return sign + '$' + (absValue / 1000000).toFixed(2) + 'M';
            } else if (absValue >= 1000) {
                return sign + '$' + (absValue / 1000).toFixed(2) + 'K';
            } else {
                return sign + '$' + absValue.toFixed(2);
            }
        }

        function formatNumber(value, decimals = 2) {
            if (value === null || value === undefined || isNaN(value)) return '-';
            return value.toFixed(decimals);
        }

        function formatPercent(value) {
            if (value === null || value === undefined || isNaN(value)) return '-';
            return value.toFixed(2) + '%';
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
        }

        // Fetch with status tracking
        async function fetchWithStatus(key, url) {
            dataStatus[key].status = 'loading';
            updateStatusDisplay();
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok) {
                    dataStatus[key].status = 'success';
                    dataStatus[key].data = data;
                    dataStatus[key].error = null;
                    return data;
                } else {
                    dataStatus[key].status = 'error';
                    dataStatus[key].error = `HTTP ${response.status}`;
                    dataStatus[key].data = null;
                    return null;
                }
            } catch (error) {
                dataStatus[key].status = 'error';
                dataStatus[key].error = error.message;
                dataStatus[key].data = null;
                return null;
            } finally {
                updateStatusDisplay();
            }
        }

        // Load dashboard
        async function loadDashboard() {
            const address = document.getElementById('addressInput').value.trim();
            if (!address) {
                showError('Please enter a valid dYdX address');
                return;
            }

            currentAddress = address;
            showLoading(true);
            hideError();

            // Reset status
            Object.keys(dataStatus).forEach(key => {
                dataStatus[key] = { status: 'idle', error: null, data: null };
            });

            try {
                // Update address display
                document.getElementById('addressDisplay').textContent = 
                    address.slice(0, 8) + '...' + address.slice(-4);

                // Fetch all data
                const [subaccountData, positionsData, ordersData, fillsData, transfersData, historicalPnlData] = await Promise.all([
                    fetchWithStatus('subaccount', `${DYDX_API}/addresses/${address}/subaccountNumber/0`),
                    fetchWithStatus('positions', `${DYDX_API}/perpetualPositions?address=${address}&subaccountNumber=0&limit=100`),
                    fetchWithStatus('orders', `${DYDX_API}/orders?address=${address}&subaccountNumber=0&limit=100`),
                    fetchWithStatus('fills', `${DYDX_API}/fills?address=${address}&subaccountNumber=0&limit=100`),
                    fetchWithStatus('transfers', `${DYDX_API}/transfers?address=${address}&subaccountNumber=0&limit=100`),
                    fetchWithStatus('historicalPnl', `${DYDX_API}/historical-pnl?address=${address}&subaccountNumber=0&limit=90`)
                ]);

                // Store all data
                allData = {
                    subaccount: subaccountData,
                    positions: positionsData,
                    orders: ordersData,
                    fills: fillsData,
                    transfers: transfersData,
                    historicalPnl: historicalPnlData
                };

                console.log('Data load complete:', allData);

                // Process and display data
                processAllData();

                showLoading(false);
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showError('Failed to load data: ' + error.message);
                showLoading(false);
            }
        }

        // Retry failed endpoints
        async function retryFailed() {
            const address = currentAddress;
            if (!address) return;

            showLoading(true);

            const retryPromises = [];
            const retryKeys = [];

            // Retry only failed endpoints
            if (dataStatus.subaccount.status === 'error') {
                retryKeys.push('subaccount');
                retryPromises.push(fetchWithStatus('subaccount', `${DYDX_API}/addresses/${address}/subaccountNumber/0`));
            }
            if (dataStatus.positions.status === 'error') {
                retryKeys.push('positions');
                retryPromises.push(fetchWithStatus('positions', `${DYDX_API}/perpetualPositions?address=${address}&subaccountNumber=0&limit=100`));
            }
            if (dataStatus.orders.status === 'error') {
                retryKeys.push('orders');
                retryPromises.push(fetchWithStatus('orders', `${DYDX_API}/orders?address=${address}&subaccountNumber=0&limit=100`));
            }
            if (dataStatus.fills.status === 'error') {
                retryKeys.push('fills');
                retryPromises.push(fetchWithStatus('fills', `${DYDX_API}/fills?address=${address}&subaccountNumber=0&limit=100`));
            }
            if (dataStatus.transfers.status === 'error') {
                retryKeys.push('transfers');
                retryPromises.push(fetchWithStatus('transfers', `${DYDX_API}/transfers?address=${address}&subaccountNumber=0&limit=100`));
            }
            if (dataStatus.historicalPnl.status === 'error') {
                retryKeys.push('historicalPnl');
                retryPromises.push(fetchWithStatus('historicalPnl', `${DYDX_API}/historical-pnl?address=${address}&subaccountNumber=0&limit=90`));
            }

            const results = await Promise.all(retryPromises);

            // Update allData with retry results
            retryKeys.forEach((key, index) => {
                if (results[index]) {
                    allData[key] = results[index];
                }
            });

            processAllData();
            showLoading(false);
        }

        // Process all data with error handling
        function processAllData() {
            // Process subaccount
            if (allData.subaccount?.subaccount) {
                const sub = allData.subaccount.subaccount;
                
                // Update primary metrics
                document.getElementById('equity').textContent = formatCurrency(parseFloat(sub.equity || 0));
                document.getElementById('freeCollateral').textContent = formatCurrency(parseFloat(sub.freeCollateral || 0));
                document.getElementById('marginUsage').textContent = formatPercent(parseFloat(sub.marginUsage || 0) * 100);
                
                // Calculate leverage
                const equity = parseFloat(sub.equity || 0);
                const marginUsage = parseFloat(sub.marginUsage || 0);
                const leverage = marginUsage > 0 ? (1 / (1 - marginUsage)) : 0;
                document.getElementById('leverage').textContent = formatNumber(leverage, 1) + 'x';
                
                // Update account details
                document.getElementById('quoteBalance').textContent = formatCurrency(parseFloat(sub.quoteBalance || 0));
                document.getElementById('pendingDeposits').textContent = formatCurrency(parseFloat(sub.pendingDeposits || 0));
                document.getElementById('pendingWithdrawals').textContent = formatCurrency(parseFloat(sub.pendingWithdrawals || 0));
                document.getElementById('createdAt').textContent = formatDate(sub.createdAt);
                document.getElementById('updatedAt').textContent = formatDateTime(sub.updatedAt);
            } else {
                // Show error in account fields
                document.getElementById('accountError')?.textContent || 
                    (document.getElementById('equity').textContent = 'Failed to load');
            }

            // Process positions
            let positions = [];
            
            // First try to get positions from subaccount response
            if (allData.subaccount?.subaccount?.openPerpetualPositions) {
                positions = Object.values(allData.subaccount.subaccount.openPerpetualPositions).map(pos => ({
                    ...pos,
                    status: pos.status || 'OPEN'
                }));
                console.log('Using positions from subaccount response:', positions);
            }
            // Fall back to separate positions endpoint
            else if (allData.positions?.positions) {
                positions = allData.positions.positions;
                console.log('Using positions from separate endpoint:', positions);
            }
            
            if (positions.length > 0) {
                processPositions(positions);
            } else if (dataStatus.positions.status === 'error') {
                document.getElementById('positionsError').textContent = '(Failed to load positions data)';
                document.getElementById('positionsTableBody').innerHTML = 
                    '<tr><td colspan="9" style="text-align: center; color: var(--warning);">Unable to load positions data</td></tr>';
            }

            // Process other data with error handling
            if (allData.orders?.orders) {
                processOrders(allData.orders.orders);
            } else if (dataStatus.orders.status === 'error') {
                document.getElementById('ordersError').textContent = '(Failed to load)';
            }

            if (allData.fills?.fills) {
                processFills(allData.fills.fills);
            } else if (dataStatus.fills.status === 'error') {
                document.getElementById('fillsError').textContent = '(Failed to load)';
            }

            if (allData.transfers?.transfers) {
                processTransfers(allData.transfers.transfers);
            } else if (dataStatus.transfers.status === 'error') {
                document.getElementById('transfersError').textContent = '(Failed to load)';
            }

            if (allData.historicalPnl?.historicalPnl) {
                processHistoricalPnl(allData.historicalPnl.historicalPnl);
            } else if (dataStatus.historicalPnl.status === 'error') {
                document.getElementById('pnlError').textContent = '(Failed to load)';
            }
        }

        // Process positions
        function processPositions(positions) {
            let openCount = 0;
            let totalRealized = 0;
            let totalUnrealized = 0;
            let wins = 0;
            let losses = 0;
            let totalWinAmount = 0;
            let totalLossAmount = 0;
            
            const positionsHtml = positions.map(pos => {
                if (pos.status === 'OPEN') {
                    openCount++;
                    totalUnrealized += parseFloat(pos.unrealizedPnl || 0);
                }
                
                const realizedPnl = parseFloat(pos.realizedPnl || 0);
                if (pos.status === 'CLOSED' && realizedPnl !== 0) {
                    totalRealized += realizedPnl;
                    if (realizedPnl > 0) {
                        wins++;
                        totalWinAmount += realizedPnl;
                    } else {
                        losses++;
                        totalLossAmount += Math.abs(realizedPnl);
                    }
                }
                
                return `
                    <tr>
                        <td>${pos.market}</td>
                        <td>${pos.status}</td>
                        <td class="${pos.side === 'LONG' ? 'profit' : 'loss'}">${pos.side}</td>
                        <td class="mono">${formatNumber(Math.abs(parseFloat(pos.size || 0)), 4)}</td>
                        <td class="mono">$${formatNumber(parseFloat(pos.entryPrice || 0))}</td>
                        <td class="mono">${pos.exitPrice ? '$' + formatNumber(parseFloat(pos.exitPrice)) : '-'}</td>
                        <td class="mono ${realizedPnl > 0 ? 'profit' : realizedPnl < 0 ? 'loss' : ''}">${formatCurrency(realizedPnl)}</td>
                        <td class="mono ${parseFloat(pos.unrealizedPnl || 0) > 0 ? 'profit' : parseFloat(pos.unrealizedPnl || 0) < 0 ? 'loss' : ''}">${formatCurrency(parseFloat(pos.unrealizedPnl || 0))}</td>
                        <td>${formatDateTime(pos.createdAt)}</td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('positionsTableBody').innerHTML = positionsHtml || '<tr><td colspan="9">No positions</td></tr>';
            document.getElementById('openPositions').textContent = openCount;
            document.getElementById('totalPnL').textContent = formatCurrency(totalRealized + totalUnrealized);
            
            // Calculate trading stats
            const totalTrades = wins + losses;
            document.getElementById('totalTrades').textContent = totalTrades;
            document.getElementById('winRate').textContent = totalTrades > 0 ? formatPercent((wins / totalTrades) * 100) : '-';
            document.getElementById('avgWin').textContent = wins > 0 ? formatCurrency(totalWinAmount / wins) : '-';
            document.getElementById('avgLoss').textContent = losses > 0 ? formatCurrency(totalLossAmount / losses) : '-';
            document.getElementById('profitFactor').textContent = totalLossAmount > 0 ? formatNumber(totalWinAmount / totalLossAmount) : '-';
            
            // Add color to total P&L
            const totalPnL = totalRealized + totalUnrealized;
            if (totalPnL > 0) document.getElementById('totalPnL').classList.add('profit');
            else if (totalPnL < 0) document.getElementById('totalPnL').classList.add('loss');
        }

        // Process orders
        function processOrders(orders) {
            const ordersHtml = orders.slice(0, 50).map(order => `
                <tr>
                    <td>${formatDateTime(order.createdAt)}</td>
                    <td>${order.ticker}</td>
                    <td class="${order.side === 'BUY' ? 'profit' : 'loss'}">${order.side}</td>
                    <td>${order.type}</td>
                    <td class="mono">${formatNumber(parseFloat(order.size || 0), 4)}</td>
                    <td class="mono">$${formatNumber(parseFloat(order.price || 0))}</td>
                    <td>${order.status}</td>
                    <td class="mono">${formatNumber(parseFloat(order.totalFilled || 0), 4)}</td>
                    <td class="mono">${formatNumber(parseFloat(order.remainingSize || 0), 4)}</td>
                </tr>
            `).join('');
            
            document.getElementById('ordersTableBody').innerHTML = ordersHtml || '<tr><td colspan="9">No orders</td></tr>';
        }

        // Process fills
        function processFills(fills) {
            const fillsHtml = fills.slice(0, 50).map(fill => `
                <tr>
                    <td>${formatDateTime(fill.createdAt)}</td>
                    <td>${fill.market}</td>
                    <td class="${fill.side === 'BUY' ? 'profit' : 'loss'}">${fill.side}</td>
                    <td>${fill.type}</td>
                    <td class="mono">${formatNumber(parseFloat(fill.size || 0), 4)}</td>
                    <td class="mono">$${formatNumber(parseFloat(fill.price || 0))}</td>
                    <td class="mono">${formatCurrency(parseFloat(fill.fee || 0))}</td>
                    <td>${fill.liquidity}</td>
                    <td style="font-size: 10px;">${fill.orderId?.slice(0, 8)}...</td>
                </tr>
            `).join('');
            
            document.getElementById('fillsTableBody').innerHTML = fillsHtml || '<tr><td colspan="9">No fills</td></tr>';
        }

        // Process transfers
        function processTransfers(transfers) {
            const transfersHtml = transfers.slice(0, 50).map(transfer => `
                <tr>
                    <td>${formatDateTime(transfer.createdAt)}</td>
                    <td>${transfer.type}</td>
                    <td class="mono ${parseFloat(transfer.size || 0) > 0 ? 'profit' : 'loss'}">${formatCurrency(parseFloat(transfer.size || 0))}</td>
                    <td style="font-size: 10px;">${transfer.sender?.address?.slice(0, 8) || '-'}...</td>
                    <td style="font-size: 10px;">${transfer.recipient?.address?.slice(0, 8) || '-'}...</td>
                    <td style="font-size: 10px;">${transfer.transactionHash?.slice(0, 8) || '-'}...</td>
                </tr>
            `).join('');
            
            document.getElementById('transfersTableBody').innerHTML = transfersHtml || '<tr><td colspan="6">No transfers</td></tr>';
        }

        // Process historical P&L
        function processHistoricalPnl(pnlData) {
            const pnlHtml = pnlData.slice(0, 30).map(day => `
                <tr>
                    <td>${formatDate(day.createdAt)}</td>
                    <td class="mono">${formatCurrency(parseFloat(day.equity || 0))}</td>
                    <td class="mono ${parseFloat(day.totalPnl || 0) > 0 ? 'profit' : 'loss'}">${formatCurrency(parseFloat(day.totalPnl || 0))}</td>
                    <td class="mono">${formatCurrency(parseFloat(day.netTransfers || 0))}</td>
                    <td>${formatDateTime(day.createdAt)}</td>
                </tr>
            `).join('');
            
            document.getElementById('pnlTableBody').innerHTML = pnlHtml || '<tr><td colspan="5">No historical data</td></tr>';
        }

        // Show/hide loading
        function showLoading(show) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
        }

        // Show error
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        // Hide error
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Check for address in URL on load
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const address = urlParams.get('address');
            
            if (address) {
                document.getElementById('addressInput').value = address;
                loadDashboard();
            }
        });

        // Enter key to load
        document.getElementById('addressInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadDashboard();
            }
        });
    </script>
</body>
</html>