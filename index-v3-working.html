<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dYdX Analytics v3.0.2 - Working</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="breadcrumb">ANALYTICS / OVERVIEW</div>
            <div class="header-right">
                <span class="status-badge live">LIVE</span>
                <div class="address mono" id="addressDisplay">Not Connected</div>
            </div>
        </div>

        <!-- Address Input Section -->
        <div style="background: var(--bg-secondary); padding: 20px; margin-bottom: 24px;">
            <div style="display: flex; gap: 16px; align-items: center;">
                <input type="text" 
                       id="addressInput" 
                       placeholder="Enter dYdX address (e.g., dydx1...)" 
                       value="dydx1agxtmjdgw7nrgs7m086m3qse7hwyf54gfeampv"
                       style="flex: 1; background: var(--bg-elevated); border: 1px solid var(--border); 
                              color: var(--text-primary); padding: 12px; font-family: 'JetBrains Mono', monospace;">
                <button id="loadDashboard" 
                        onclick="loadDashboard()"
                        style="padding: 12px 24px; background: var(--text-primary); color: var(--bg-primary);
                               border: none; cursor: pointer; font-weight: 600; text-transform: uppercase;">
                    Load Dashboard
                </button>
            </div>
        </div>

        <!-- Data Warning (shown when data is incomplete) -->
        <div id="dataWarning" style="background: rgba(245, 158, 11, 0.1); border: 1px solid var(--warning); 
                                     padding: 12px; margin-bottom: 20px; border-radius: 4px; display: none;">
            <div style="font-weight: 600; color: var(--warning); margin-bottom: 4px;">âš  Incomplete Data</div>
            <div id="warningText" style="font-size: 13px; color: var(--text-secondary);"></div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="overview">OVERVIEW</div>
            <div class="nav-tab" data-tab="performance">PERFORMANCE</div>
            <div class="nav-tab" data-tab="risk">RISK ANALYSIS</div>
            <div class="nav-tab" data-tab="positions">POSITIONS</div>
            <div class="nav-tab" data-tab="behavior">BEHAVIOR</div>
            <div class="nav-tab" data-tab="market">MARKET STRUCTURE</div>
        </div>

        <!-- Loading State -->
        <div id="loader" class="loading" style="display: none;">
            <div class="spinner"></div>
            <div style="margin-top: 16px;">Loading portfolio data...</div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <!-- Overview Tab -->
        <div class="tab-content active" id="overview">
            <!-- Primary Metrics -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Equity</div>
                    <div class="metric-value mono" id="equity">-</div>
                    <div class="metric-change mono">Total Value</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Free Collateral</div>
                    <div class="metric-value mono" id="freeCollateral">-</div>
                    <div class="metric-change mono">Available</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Margin Usage</div>
                    <div class="metric-value mono" id="marginUsage">-</div>
                    <div class="metric-change mono">Utilization</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Leverage</div>
                    <div class="metric-value mono" id="leverage">-</div>
                    <div class="metric-change mono">Current</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Open Positions</div>
                    <div class="metric-value mono" id="openPositions">-</div>
                    <div class="metric-change mono">Active</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total P&L</div>
                    <div class="metric-value mono" id="totalPnL">-</div>
                    <div class="metric-change mono">All Time</div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="two-column">
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Trading Statistics</div>
                    </div>
                    <table>
                        <tr>
                            <td style="color: var(--text-secondary)">Total Trades</td>
                            <td class="mono" id="totalTrades">-</td>
                        </tr>
                        <tr>
                            <td style="color: var(--text-secondary)">Win Rate</td>
                            <td class="mono" id="winRate">-</td>
                        </tr>
                        <tr>
                            <td style="color: var(--text-secondary)">Average Win</td>
                            <td class="mono" id="avgWin">-</td>
                        </tr>
                        <tr>
                            <td style="color: var(--text-secondary)">Average Loss</td>
                            <td class="mono" id="avgLoss">-</td>
                        </tr>
                        <tr>
                            <td style="color: var(--text-secondary)">Profit Factor</td>
                            <td class="mono" id="profitFactor">-</td>
                        </tr>
                    </table>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Account Details</div>
                    </div>
                    <table>
                        <tr>
                            <td style="color: var(--text-secondary)">Quote Balance</td>
                            <td class="mono" id="quoteBalance">-</td>
                        </tr>
                        <tr>
                            <td style="color: var(--text-secondary)">Pending Deposits</td>
                            <td class="mono" id="pendingDeposits">-</td>
                        </tr>
                        <tr>
                            <td style="color: var(--text-secondary)">Pending Withdrawals</td>
                            <td class="mono" id="pendingWithdrawals">-</td>
                        </tr>
                        <tr>
                            <td style="color: var(--text-secondary)">Created At</td>
                            <td class="mono" id="createdAt">-</td>
                        </tr>
                        <tr>
                            <td style="color: var(--text-secondary)">Updated At</td>
                            <td class="mono" id="updatedAt">-</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Positions Tab -->
        <div class="tab-content" id="positions">
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Perpetual Positions</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>MARKET</th>
                            <th>STATUS</th>
                            <th>SIDE</th>
                            <th>SIZE</th>
                            <th>MAX SIZE</th>
                            <th>ENTRY PRICE</th>
                            <th>EXIT PRICE</th>
                            <th>REALIZED P&L</th>
                            <th>UNREALIZED P&L</th>
                            <th>CREATED</th>
                        </tr>
                    </thead>
                    <tbody id="positionsTableBody">
                        <tr><td colspan="10" style="text-align: center;">No data loaded</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Orders Tab -->
        <div class="tab-content" id="orders">
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Orders</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>TIME</th>
                            <th>MARKET</th>
                            <th>SIDE</th>
                            <th>TYPE</th>
                            <th>SIZE</th>
                            <th>PRICE</th>
                            <th>STATUS</th>
                            <th>FILLED</th>
                            <th>REMAINING</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        <tr><td colspan="9" style="text-align: center;">No data loaded</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Performance Tab -->
        <div class="tab-content" id="performance">
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Performance Metrics</div>
                </div>
                <table>
                    <tr>
                        <td style="color: var(--text-secondary)">Total Return</td>
                        <td class="mono" id="totalReturn">-</td>
                    </tr>
                    <tr>
                        <td style="color: var(--text-secondary)">Daily Return</td>
                        <td class="mono" id="dailyReturn">-</td>
                    </tr>
                    <tr>
                        <td style="color: var(--text-secondary)">Monthly Return</td>
                        <td class="mono" id="monthlyReturn">-</td>
                    </tr>
                    <tr>
                        <td style="color: var(--text-secondary)">Sharpe Ratio</td>
                        <td class="mono" id="sharpeRatio">-</td>
                    </tr>
                    <tr>
                        <td style="color: var(--text-secondary)">Sortino Ratio</td>
                        <td class="mono" id="sortinoRatio">-</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Risk Analysis Tab -->
        <div class="tab-content" id="risk">
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Risk Metrics</div>
                </div>
                <table>
                    <tr>
                        <td style="color: var(--text-secondary)">Value at Risk (95%)</td>
                        <td class="mono" id="var95">-</td>
                    </tr>
                    <tr>
                        <td style="color: var(--text-secondary)">Conditional VaR</td>
                        <td class="mono" id="cvar">-</td>
                    </tr>
                    <tr>
                        <td style="color: var(--text-secondary)">Max Drawdown</td>
                        <td class="mono" id="maxDrawdown">-</td>
                    </tr>
                    <tr>
                        <td style="color: var(--text-secondary)">Current Drawdown</td>
                        <td class="mono" id="currentDrawdown">-</td>
                    </tr>
                    <tr>
                        <td style="color: var(--text-secondary)">Kelly Criterion</td>
                        <td class="mono" id="kellyCriterion">-</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Behavior Tab -->
        <div class="tab-content" id="behavior">
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Trading Behavior</div>
                </div>
                <table>
                    <tr>
                        <td style="color: var(--text-secondary)">Avg Hold Time</td>
                        <td class="mono" id="avgHoldTime">-</td>
                    </tr>
                    <tr>
                        <td style="color: var(--text-secondary)">Trade Frequency</td>
                        <td class="mono" id="tradeFrequency">-</td>
                    </tr>
                    <tr>
                        <td style="color: var(--text-secondary)">Most Traded Market</td>
                        <td class="mono" id="mostTradedMarket">-</td>
                    </tr>
                    <tr>
                        <td style="color: var(--text-secondary)">Avg Position Size</td>
                        <td class="mono" id="avgPositionSize">-</td>
                    </tr>
                    <tr>
                        <td style="color: var(--text-secondary)">Risk/Reward Ratio</td>
                        <td class="mono" id="riskRewardRatio">-</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Market Structure Tab -->
        <div class="tab-content" id="market">
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Market Analysis</div>
                </div>
                <table>
                    <tr>
                        <td style="color: var(--text-secondary)">Market Exposure</td>
                        <td class="mono" id="marketExposure">-</td>
                    </tr>
                    <tr>
                        <td style="color: var(--text-secondary)">Correlation to BTC</td>
                        <td class="mono" id="btcCorrelation">-</td>
                    </tr>
                    <tr>
                        <td style="color: var(--text-secondary)">Beta</td>
                        <td class="mono" id="beta">-</td>
                    </tr>
                    <tr>
                        <td style="color: var(--text-secondary)">Market Regime</td>
                        <td class="mono" id="marketRegime">-</td>
                    </tr>
                    <tr>
                        <td style="color: var(--text-secondary)">Volatility</td>
                        <td class="mono" id="volatility">-</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const DYDX_API = 'https://indexer.dydx.trade/v4';
        let currentAddress = null;
        let allData = {};
        let dataErrors = [];

        // Tab navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                const tabId = this.dataset.tab;
                document.getElementById(tabId)?.classList.add('active');
            });
        });

        // Format functions
        function formatCurrency(value) {
            if (value === null || value === undefined || isNaN(value)) return '-';
            const absValue = Math.abs(value);
            const sign = value >= 0 ? '+' : '-';
            
            if (absValue >= 1000000) {
                return sign + '$' + (absValue / 1000000).toFixed(2) + 'M';
            } else if (absValue >= 1000) {
                return sign + '$' + (absValue / 1000).toFixed(2) + 'K';
            } else {
                return sign + '$' + absValue.toFixed(2);
            }
        }

        function formatNumber(value, decimals = 2) {
            if (value === null || value === undefined || isNaN(value)) return '-';
            return value.toFixed(decimals);
        }

        function formatPercent(value) {
            if (value === null || value === undefined || isNaN(value)) return '-';
            return value.toFixed(2) + '%';
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
        }

        // Load dashboard
        async function loadDashboard() {
            const address = document.getElementById('addressInput').value.trim();
            if (!address) {
                showError('Please enter a valid dYdX address');
                return;
            }

            currentAddress = address;
            showLoading(true);
            hideError();
            dataErrors = [];

            try {
                // Update address display
                document.getElementById('addressDisplay').textContent = 
                    address.slice(0, 8) + '...' + address.slice(-4);

                // Fetch all data using correct endpoints (removed fills and transfers)
                const [
                    subaccountRes,
                    positionsRes,
                    ordersRes,
                    historicalPnlRes
                ] = await Promise.all([
                    // Get subaccount details
                    fetch(`${DYDX_API}/addresses/${address}/subaccountNumber/0`),
                    // Get perpetual positions - using query params
                    fetch(`${DYDX_API}/perpetualPositions?address=${address}&subaccountNumber=0&limit=100`),
                    // Get orders - using query params
                    fetch(`${DYDX_API}/orders?address=${address}&subaccountNumber=0&limit=100`),
                    // Get historical P&L - using query params (correct endpoint name)
                    fetch(`${DYDX_API}/historical-pnl?address=${address}&subaccountNumber=0&limit=90`)
                ]);

                // Parse responses and track errors
                let subaccountData = null;
                let positionsData = null;
                let ordersData = null;
                let historicalPnlData = null;

                if (subaccountRes.ok) {
                    subaccountData = await subaccountRes.json();
                } else {
                    dataErrors.push('Account data');
                }

                if (positionsRes.ok) {
                    positionsData = await positionsRes.json();
                } else {
                    dataErrors.push('Positions');
                }

                if (ordersRes.ok) {
                    ordersData = await ordersRes.json();
                } else {
                    dataErrors.push('Orders');
                }

                if (historicalPnlRes.ok) {
                    historicalPnlData = await historicalPnlRes.json();
                } else {
                    dataErrors.push('Historical P&L');
                }

                // Store all data
                allData = {
                    subaccount: subaccountData,
                    positions: positionsData,
                    orders: ordersData,
                    historicalPnl: historicalPnlData
                };

                console.log('All data loaded:', allData);

                // Show warning if some data failed to load
                if (dataErrors.length > 0) {
                    const warningDiv = document.getElementById('dataWarning');
                    const warningText = document.getElementById('warningText');
                    warningText.textContent = `Failed to load: ${dataErrors.join(', ')}. Some metrics may be unavailable.`;
                    warningDiv.style.display = 'block';
                } else {
                    document.getElementById('dataWarning').style.display = 'none';
                }

                // Process and display data
                processAllData();

                showLoading(false);
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showError('Failed to load data: ' + error.message);
                showLoading(false);
            }
        }

        // Process all data
        function processAllData() {
            // Process subaccount
            if (allData.subaccount?.subaccount) {
                const sub = allData.subaccount.subaccount;
                
                // Update primary metrics
                document.getElementById('equity').textContent = formatCurrency(parseFloat(sub.equity || 0));
                document.getElementById('freeCollateral').textContent = formatCurrency(parseFloat(sub.freeCollateral || 0));
                document.getElementById('marginUsage').textContent = formatPercent(parseFloat(sub.marginUsage || 0) * 100);
                
                // Calculate leverage
                const equity = parseFloat(sub.equity || 0);
                const marginUsage = parseFloat(sub.marginUsage || 0);
                const leverage = marginUsage > 0 ? (1 / (1 - marginUsage)) : 0;
                document.getElementById('leverage').textContent = formatNumber(leverage, 1) + 'x';
                
                // Update account details
                document.getElementById('quoteBalance').textContent = formatCurrency(parseFloat(sub.quoteBalance || 0));
                document.getElementById('pendingDeposits').textContent = formatCurrency(parseFloat(sub.pendingDeposits || 0));
                document.getElementById('pendingWithdrawals').textContent = formatCurrency(parseFloat(sub.pendingWithdrawals || 0));
                document.getElementById('createdAt').textContent = formatDate(sub.createdAt);
                document.getElementById('updatedAt').textContent = formatDateTime(sub.updatedAt);
            }

            // Process positions - first check subaccount, then separate endpoint
            let positions = [];
            
            // First try to get positions from subaccount response
            if (allData.subaccount?.subaccount?.openPerpetualPositions) {
                // Convert object to array
                positions = Object.values(allData.subaccount.subaccount.openPerpetualPositions).map(pos => ({
                    ...pos,
                    status: pos.status || 'OPEN'
                }));
                console.log('Using positions from subaccount response:', positions);
            }
            // Fall back to separate positions endpoint
            else if (allData.positions?.positions) {
                positions = allData.positions.positions;
                console.log('Using positions from separate endpoint:', positions);
            }
            
            if (positions.length > 0) {
                let openCount = 0;
                let totalRealized = 0;
                let totalUnrealized = 0;
                let wins = 0;
                let losses = 0;
                let totalWinAmount = 0;
                let totalLossAmount = 0;
                
                const positionsHtml = positions.map(pos => {
                    if (pos.status === 'OPEN') {
                        openCount++;
                        totalUnrealized += parseFloat(pos.unrealizedPnl || 0);
                    }
                    
                    const realizedPnl = parseFloat(pos.realizedPnl || 0);
                    if (pos.status === 'CLOSED' && realizedPnl !== 0) {
                        totalRealized += realizedPnl;
                        if (realizedPnl > 0) {
                            wins++;
                            totalWinAmount += realizedPnl;
                        } else {
                            losses++;
                            totalLossAmount += Math.abs(realizedPnl);
                        }
                    }
                    
                    return `
                        <tr>
                            <td>${pos.market}</td>
                            <td>${pos.status}</td>
                            <td class="${pos.side === 'LONG' ? 'profit' : 'loss'}">${pos.side}</td>
                            <td class="mono">${formatNumber(Math.abs(parseFloat(pos.size || 0)), 4)}</td>
                            <td class="mono">${formatNumber(Math.abs(parseFloat(pos.maxSize || 0)), 4)}</td>
                            <td class="mono">$${formatNumber(parseFloat(pos.entryPrice || 0))}</td>
                            <td class="mono">${pos.exitPrice ? '$' + formatNumber(parseFloat(pos.exitPrice)) : '-'}</td>
                            <td class="mono ${realizedPnl > 0 ? 'profit' : realizedPnl < 0 ? 'loss' : ''}">${formatCurrency(realizedPnl)}</td>
                            <td class="mono ${parseFloat(pos.unrealizedPnl || 0) > 0 ? 'profit' : parseFloat(pos.unrealizedPnl || 0) < 0 ? 'loss' : ''}">${formatCurrency(parseFloat(pos.unrealizedPnl || 0))}</td>
                            <td>${formatDateTime(pos.createdAt)}</td>
                        </tr>
                    `;
                }).join('');
                
                document.getElementById('positionsTableBody').innerHTML = positionsHtml || '<tr><td colspan="10">No positions</td></tr>';
                document.getElementById('openPositions').textContent = openCount;
                document.getElementById('totalPnL').textContent = formatCurrency(totalRealized + totalUnrealized);
                
                // Calculate trading stats
                const totalTrades = wins + losses;
                document.getElementById('totalTrades').textContent = totalTrades;
                document.getElementById('winRate').textContent = totalTrades > 0 ? formatPercent((wins / totalTrades) * 100) : '-';
                document.getElementById('avgWin').textContent = wins > 0 ? formatCurrency(totalWinAmount / wins) : '-';
                document.getElementById('avgLoss').textContent = losses > 0 ? formatCurrency(totalLossAmount / losses) : '-';
                document.getElementById('profitFactor').textContent = totalLossAmount > 0 ? formatNumber(totalWinAmount / totalLossAmount) : '-';
                
                // Add color to total P&L
                const totalPnL = totalRealized + totalUnrealized;
                if (totalPnL > 0) document.getElementById('totalPnL').classList.add('profit');
                else if (totalPnL < 0) document.getElementById('totalPnL').classList.add('loss');
            }

            // Process orders
            if (allData.orders?.orders) {
                const orders = allData.orders.orders;
                const ordersHtml = orders.slice(0, 50).map(order => `
                    <tr>
                        <td>${formatDateTime(order.createdAt)}</td>
                        <td>${order.ticker}</td>
                        <td class="${order.side === 'BUY' ? 'profit' : 'loss'}">${order.side}</td>
                        <td>${order.type}</td>
                        <td class="mono">${formatNumber(parseFloat(order.size || 0), 4)}</td>
                        <td class="mono">$${formatNumber(parseFloat(order.price || 0))}</td>
                        <td>${order.status}</td>
                        <td class="mono">${formatNumber(parseFloat(order.totalFilled || 0), 4)}</td>
                        <td class="mono">${formatNumber(parseFloat(order.remainingSize || 0), 4)}</td>
                    </tr>
                `).join('');
                
                document.getElementById('ordersTableBody').innerHTML = ordersHtml || '<tr><td colspan="9">No orders</td></tr>';
            }

            // Process historical P&L for behavior metrics
            if (allData.historicalPnl?.historicalPnl) {
                const pnlData = allData.historicalPnl.historicalPnl;
                // Can calculate behavior metrics from historical data
                if (pnlData.length > 0) {
                    // Simple calculations for now - can be enhanced
                    document.getElementById('tradeFrequency').textContent = `${pnlData.length} days active`;
                }
            }
        }

        // Show/hide loading
        function showLoading(show) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
        }

        // Show error
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        // Hide error
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Check for address in URL on load
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const address = urlParams.get('address');
            
            if (address) {
                document.getElementById('addressInput').value = address;
                loadDashboard();
            }
        });

        // Enter key to load
        document.getElementById('addressInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadDashboard();
            }
        });
    </script>
</body>
</html>