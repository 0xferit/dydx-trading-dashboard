<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dYdX Analytics - dydx1agx...ampv</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0A0A0A;
            --bg-secondary: #121212;
            --bg-elevated: #1E1E1E;
            --bg-hover: #252525;
            --text-primary: rgba(255, 255, 255, 0.95);
            --text-secondary: rgba(255, 255, 255, 0.6);
            --text-tertiary: rgba(255, 255, 255, 0.4);
            --border: rgba(255, 255, 255, 0.1);
            --profit: #10B981;
            --loss: #EF4444;
            --warning: #F59E0B;
            --grid-unit: 8px;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            font-size: 14px;
            overflow-x: hidden;
        }

        .mono {
            font-family: 'JetBrains Mono', 'SF Mono', 'Monaco', monospace;
            font-variant-numeric: tabular-nums;
        }

        .container {
            max-width: 1920px;
            margin: 0 auto;
            padding: calc(var(--grid-unit) * 3);
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: calc(var(--grid-unit) * 3);
            border-bottom: 1px solid var(--border);
            padding-bottom: calc(var(--grid-unit) * 2);
        }

        .breadcrumb {
            color: var(--text-tertiary);
            font-size: 12px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: calc(var(--grid-unit) * 3);
        }

        .address {
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.15s;
        }

        .address:hover {
            color: var(--text-primary);
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: calc(var(--grid-unit) * 4);
            margin-bottom: calc(var(--grid-unit) * 4);
            border-bottom: 1px solid var(--border);
        }

        .nav-tab {
            padding: calc(var(--grid-unit) * 1.5) 0;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-tertiary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.15s;
            margin-bottom: -1px;
        }

        .nav-tab:hover {
            color: var(--text-secondary);
        }

        .nav-tab.active {
            color: var(--text-primary);
            border-bottom-color: var(--text-primary);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Key Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: calc(var(--grid-unit) * 2);
            margin-bottom: calc(var(--grid-unit) * 4);
        }

        .metric-card {
            background: var(--bg-secondary);
            padding: calc(var(--grid-unit) * 2.5);
            position: relative;
            border: 1px solid transparent;
            transition: border-color 0.15s;
        }

        .metric-card:hover {
            border-color: var(--border);
        }

        .metric-label {
            font-size: 11px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: calc(var(--grid-unit) * 1);
        }

        .metric-value {
            font-size: 24px;
            font-weight: 500;
            line-height: 1;
            margin-bottom: calc(var(--grid-unit) * 0.5);
        }

        .metric-change {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .metric-sparkline {
            position: absolute;
            right: calc(var(--grid-unit) * 2);
            top: calc(var(--grid-unit) * 2);
            width: 50px;
            height: 20px;
            opacity: 0.3;
        }

        .profit { color: var(--profit); }
        .loss { color: var(--loss); }
        .warning { color: var(--warning); }

        /* Chart Area */
        .chart-container {
            background: var(--bg-secondary);
            padding: calc(var(--grid-unit) * 3);
            margin-bottom: calc(var(--grid-unit) * 4);
            height: 400px;
            position: relative;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: calc(var(--grid-unit) * 3);
        }

        .chart-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
        }

        .time-selector {
            display: flex;
            gap: calc(var(--grid-unit) * 2);
        }

        .time-option {
            padding: 4px 8px;
            font-size: 11px;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid transparent;
        }

        .time-option:hover {
            color: var(--text-secondary);
        }

        .time-option.active {
            color: var(--text-primary);
            border-bottom: 1px solid var(--text-primary);
        }

        /* SVG Chart */
        .chart-svg {
            width: 100%;
            height: 320px;
        }

        .chart-line {
            fill: none;
            stroke: var(--text-primary);
            stroke-width: 2;
            opacity: 0.9;
        }

        .chart-area {
            fill: var(--text-primary);
            opacity: 0.05;
        }

        .chart-grid-line {
            stroke: var(--border);
            stroke-width: 1;
            opacity: 0.5;
        }

        /* Tables */
        .table-container {
            background: var(--bg-secondary);
            margin-bottom: calc(var(--grid-unit) * 4);
            overflow-x: auto;
        }

        .table-header {
            padding: calc(var(--grid-unit) * 2) calc(var(--grid-unit) * 3);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: right;
            padding: calc(var(--grid-unit) * 1.5) calc(var(--grid-unit) * 2);
            font-size: 10px;
            font-weight: 500;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        th:first-child,
        td:first-child {
            text-align: left;
            padding-left: calc(var(--grid-unit) * 3);
        }

        td {
            padding: calc(var(--grid-unit) * 1.5) calc(var(--grid-unit) * 2);
            text-align: right;
            font-size: 12px;
            border-top: 1px solid var(--border);
        }

        tr:hover td {
            background: var(--bg-elevated);
        }

        /* Grid Layouts */
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: calc(var(--grid-unit) * 3);
            margin-bottom: calc(var(--grid-unit) * 4);
        }

        .three-column {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: calc(var(--grid-unit) * 3);
            margin-bottom: calc(var(--grid-unit) * 4);
        }

        /* Risk Bar */
        .risk-bar {
            height: 3px;
            background: var(--bg-elevated);
            margin-top: calc(var(--grid-unit) * 1);
            position: relative;
        }

        .risk-bar-fill {
            height: 100%;
            background: var(--text-primary);
            opacity: 0.3;
            position: absolute;
            left: 0;
            top: 0;
        }

        .risk-bar-fill.danger {
            background: var(--loss);
            opacity: 0.6;
        }

        .risk-bar-fill.warning {
            background: var(--warning);
            opacity: 0.5;
        }

        /* Correlation Matrix */
        .correlation-matrix {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 2px;
            margin-top: calc(var(--grid-unit) * 2);
        }

        .correlation-cell {
            aspect-ratio: 1;
            background: var(--bg-elevated);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: var(--text-secondary);
        }

        /* Heatmap */
        .heatmap {
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            grid-template-rows: repeat(7, 1fr);
            gap: 2px;
            margin-top: calc(var(--grid-unit) * 3);
            height: 140px;
        }

        .heatmap-cell {
            background: var(--bg-elevated);
            transition: opacity 0.15s;
            cursor: pointer;
        }

        .heatmap-cell:hover {
            outline: 1px solid var(--text-primary);
            outline-offset: -1px;
        }

        /* Distribution Chart */
        .distribution-bars {
            display: flex;
            align-items: flex-end;
            height: 100px;
            gap: 2px;
            margin-top: calc(var(--grid-unit) * 2);
        }

        .distribution-bar {
            flex: 1;
            background: var(--text-primary);
            opacity: 0.2;
            min-height: 2px;
        }

        /* Command Palette Hint */
        .cmd-hint {
            position: fixed;
            bottom: calc(var(--grid-unit) * 3);
            right: calc(var(--grid-unit) * 3);
            font-size: 11px;
            color: var(--text-tertiary);
            padding: calc(var(--grid-unit) * 1) calc(var(--grid-unit) * 2);
            background: var(--bg-secondary);
            border: 1px solid var(--border);
        }

        .key {
            display: inline-block;
            padding: 2px 4px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            margin: 0 2px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
        }

        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 2px 6px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--bg-elevated);
            color: var(--text-secondary);
        }

        .status-badge.live {
            background: var(--profit);
            color: var(--bg-primary);
        }

        /* Behavioral Score Cards */
        .behavior-card {
            background: var(--bg-secondary);
            padding: calc(var(--grid-unit) * 3);
            margin-bottom: calc(var(--grid-unit) * 2);
        }

        .behavior-score {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: calc(var(--grid-unit) * 2);
        }

        .score-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .score-value {
            font-size: 18px;
            font-weight: 500;
        }

        /* Mini Chart */
        .mini-chart {
            width: 100%;
            height: 60px;
            margin-top: calc(var(--grid-unit) * 2);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="breadcrumb">ANALYTICS / COMPREHENSIVE</div>
            <div class="header-right">
                <span class="status-badge live">LIVE</span>
                <div class="address mono">dydx1agx...ampv</div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="overview">OVERVIEW</div>
            <div class="nav-tab" data-tab="performance">PERFORMANCE</div>
            <div class="nav-tab" data-tab="risk">RISK ANALYSIS</div>
            <div class="nav-tab" data-tab="positions">POSITIONS</div>
            <div class="nav-tab" data-tab="behavior">BEHAVIOR</div>
            <div class="nav-tab" data-tab="market">MARKET STRUCTURE</div>
        </div>

        <!-- Overview Tab -->
        <div class="tab-content active" id="overview">
            <!-- Primary Metrics -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Total P&L</div>
                    <div class="metric-value mono" id="totalPnL">-</div>
                    <div class="metric-change mono" id="totalPnLChange">Loading...</div>
                    <svg class="metric-sparkline" viewBox="0 0 50 20">
                        <polyline points="0,15 10,12 20,10 30,8 40,5 50,3" fill="none" stroke="var(--profit)" stroke-width="1"/>
                    </svg>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Win Rate</div>
                    <div class="metric-value mono" id="winRate">-</div>
                    <div class="metric-change mono" id="winRateDetail">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Profit Factor</div>
                    <div class="metric-value mono" id="profitFactor">-</div>
                    <div class="metric-change mono" id="profitFactorDetail">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Sharpe Ratio</div>
                    <div class="metric-value mono" id="sharpeRatio">-</div>
                    <div class="metric-change mono">30-day rolling</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Sortino Ratio</div>
                    <div class="metric-value mono" id="sortinoRatio">-</div>
                    <div class="metric-change mono">Downside focus</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Max Drawdown</div>
                    <div class="metric-value mono" id="maxDrawdown">-</div>
                    <div class="metric-change mono" id="maxDrawdownDetail">-</div>
                </div>
            </div>

            <!-- Trading Activity Chart (Market Distribution) -->
            <div class="chart-container" style="height: 400px;">
                <div class="chart-header">
                    <div class="chart-title">Trading Activity by Market</div>
                </div>
                <canvas id="marketDistributionChart" style="max-width: 400px; margin: 0 auto;"></canvas>
            </div>

            <!-- P&L Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">Cumulative P&L with Drawdown Periods</div>
                    <div class="time-selector">
                        <div class="time-option">1D</div>
                        <div class="time-option">7D</div>
                        <div class="time-option active">30D</div>
                        <div class="time-option">90D</div>
                        <div class="time-option">1Y</div>
                        <div class="time-option">ALL</div>
                    </div>
                </div>
                <svg class="chart-svg" viewBox="0 0 1200 320">
                    <!-- Drawdown periods -->
                    <rect x="200" y="0" width="80" height="320" fill="var(--loss)" opacity="0.05"/>
                    <rect x="480" y="0" width="60" height="320" fill="var(--loss)" opacity="0.05"/>
                    
                    <!-- Grid lines -->
                    <line x1="0" y1="80" x2="1200" y2="80" class="chart-grid-line"/>
                    <line x1="0" y1="160" x2="1200" y2="160" class="chart-grid-line"/>
                    <line x1="0" y1="240" x2="1200" y2="240" class="chart-grid-line"/>
                    
                    <!-- Chart area -->
                    <path d="M 0,240 L 40,235 L 80,220 L 120,225 L 160,210 L 200,205 L 240,215 L 280,210 L 320,195 L 360,200 L 400,190 L 440,180 L 480,185 L 520,175 L 560,160 L 600,150 L 640,145 L 680,135 L 720,130 L 760,120 L 800,115 L 840,105 L 880,100 L 920,90 L 960,85 L 1000,75 L 1040,70 L 1080,60 L 1120,55 L 1160,50 L 1200,45 L 1200,320 L 0,320 Z" class="chart-area"/>
                    
                    <!-- Main line -->
                    <path d="M 0,240 L 40,235 L 80,220 L 120,225 L 160,210 L 200,205 L 240,215 L 280,210 L 320,195 L 360,200 L 400,190 L 440,180 L 480,185 L 520,175 L 560,160 L 600,150 L 640,145 L 680,135 L 720,130 L 760,120 L 800,115 L 840,105 L 880,100 L 920,90 L 960,85 L 1000,75 L 1040,70 L 1080,60 L 1120,55 L 1160,50 L 1200,45" class="chart-line"/>
                    
                    <!-- Value labels -->
                    <text x="1200" y="40" fill="var(--text-primary)" text-anchor="end" font-size="12" class="mono">$47,293</text>
                    <text x="0" y="255" fill="var(--text-secondary)" font-size="10" class="mono">Mar 1</text>
                    <text x="1200" y="255" fill="var(--text-secondary)" text-anchor="end" font-size="10" class="mono">Mar 31</text>
                </svg>
            </div>

            <!-- Quick Stats Grid -->
            <div class="two-column">
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Trading Statistics</div>
                    </div>
                    <table>
                        <tr>
                            <td style="color: var(--text-secondary)">Average Win</td>
                            <td class="mono profit" id="avgWin">-</td>
                        </tr>
                        <tr>
                            <td style="color: var(--text-secondary)">Average Loss</td>
                            <td class="mono loss" id="avgLoss">-</td>
                        </tr>
                        <tr>
                            <td style="color: var(--text-secondary)">Risk/Reward Ratio</td>
                            <td class="mono" id="riskReward">-</td>
                        </tr>
                        <tr>
                            <td style="color: var(--text-secondary)">Trade Expectancy</td>
                            <td class="mono profit" id="expectancy">-</td>
                        </tr>
                        <tr>
                            <td style="color: var(--text-secondary)">Recovery Factor</td>
                            <td class="mono" id="recoveryFactor">-</td>
                        </tr>
                    </table>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Time Analysis</div>
                    </div>
                    <table>
                        <tr>
                            <td style="color: var(--text-secondary)">Avg Hold Time (Win)</td>
                            <td class="mono">4h 23m</td>
                        </tr>
                        <tr>
                            <td style="color: var(--text-secondary)">Avg Hold Time (Loss)</td>
                            <td class="mono">1h 47m</td>
                        </tr>
                        <tr>
                            <td style="color: var(--text-secondary)">Best Trading Hour</td>
                            <td class="mono">14:00 UTC</td>
                        </tr>
                        <tr>
                            <td style="color: var(--text-secondary)">Worst Trading Hour</td>
                            <td class="mono">03:00 UTC</td>
                        </tr>
                        <tr>
                            <td style="color: var(--text-secondary)">Most Active Day</td>
                            <td class="mono">Wednesday</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Performance Tab -->
        <div class="tab-content" id="performance">
            <!-- Advanced Performance Metrics -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Calmar Ratio</div>
                    <div class="metric-value mono">3.47</div>
                    <div class="metric-change mono">Annual return / Max DD</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Kelly Criterion</div>
                    <div class="metric-value mono">18.7%</div>
                    <div class="metric-change mono">Optimal size</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Max Consec. Wins</div>
                    <div class="metric-value mono">12</div>
                    <div class="metric-change mono profit">+$5,847</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Max Consec. Losses</div>
                    <div class="metric-value mono">7</div>
                    <div class="metric-change mono loss">-$2,194</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Average RRR</div>
                    <div class="metric-value mono">2.31:1</div>
                    <div class="metric-change mono">vs 2:1 target</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Win Rate Trend</div>
                    <div class="metric-value mono profit">↑ 71.2%</div>
                    <div class="metric-change mono">Last 50 trades</div>
                </div>
            </div>

            <!-- Win/Loss Distribution -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Win/Loss Distribution</div>
                </div>
                <div class="distribution-bars" id="winLossDistribution"></div>
            </div>

            <!-- Monthly Performance -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Monthly Performance Breakdown</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>MONTH</th>
                            <th>P&L</th>
                            <th>WIN RATE</th>
                            <th>TRADES</th>
                            <th>AVG WIN</th>
                            <th>AVG LOSS</th>
                            <th>PROFIT FACTOR</th>
                            <th>MAX DD</th>
                            <th>SHARPE</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>March 2024</td>
                            <td class="mono profit">+$12,847</td>
                            <td class="mono">71.2%</td>
                            <td class="mono">47</td>
                            <td class="mono profit">+$487</td>
                            <td class="mono loss">-$213</td>
                            <td class="mono">2.48</td>
                            <td class="mono loss">-8.4%</td>
                            <td class="mono">2.31</td>
                        </tr>
                        <tr>
                            <td>February 2024</td>
                            <td class="mono profit">+$18,392</td>
                            <td class="mono">68.4%</td>
                            <td class="mono">62</td>
                            <td class="mono profit">+$524</td>
                            <td class="mono loss">-$198</td>
                            <td class="mono">2.67</td>
                            <td class="mono loss">-11.2%</td>
                            <td class="mono">2.87</td>
                        </tr>
                        <tr>
                            <td>January 2024</td>
                            <td class="mono profit">+$9,184</td>
                            <td class="mono">65.8%</td>
                            <td class="mono">38</td>
                            <td class="mono profit">+$412</td>
                            <td class="mono loss">-$187</td>
                            <td class="mono">2.19</td>
                            <td class="mono loss">-6.7%</td>
                            <td class="mono">1.94</td>
                        </tr>
                        <tr>
                            <td>December 2023</td>
                            <td class="mono profit">+$6,870</td>
                            <td class="mono">64.3%</td>
                            <td class="mono">42</td>
                            <td class="mono profit">+$398</td>
                            <td class="mono loss">-$201</td>
                            <td class="mono">1.98</td>
                            <td class="mono loss">-9.1%</td>
                            <td class="mono">1.76</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Asset Performance -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Performance by Asset</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ASSET</th>
                            <th>P&L</th>
                            <th>TRADES</th>
                            <th>WIN RATE</th>
                            <th>AVG P&L</th>
                            <th>BEST</th>
                            <th>WORST</th>
                            <th>SHARPE</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>BTC-USD</td>
                            <td class="mono profit">+$21,847</td>
                            <td class="mono">124</td>
                            <td class="mono">72.4%</td>
                            <td class="mono profit">+$176</td>
                            <td class="mono profit">+$2,847</td>
                            <td class="mono loss">-$1,293</td>
                            <td class="mono">2.67</td>
                        </tr>
                        <tr>
                            <td>ETH-USD</td>
                            <td class="mono profit">+$14,293</td>
                            <td class="mono">98</td>
                            <td class="mono">68.9%</td>
                            <td class="mono profit">+$146</td>
                            <td class="mono profit">+$1,984</td>
                            <td class="mono loss">-$847</td>
                            <td class="mono">2.31</td>
                        </tr>
                        <tr>
                            <td>SOL-USD</td>
                            <td class="mono profit">+$8,472</td>
                            <td class="mono">87</td>
                            <td class="mono">65.5%</td>
                            <td class="mono profit">+$97</td>
                            <td class="mono profit">+$1,247</td>
                            <td class="mono loss">-$623</td>
                            <td class="mono">1.98</td>
                        </tr>
                        <tr>
                            <td>AVAX-USD</td>
                            <td class="mono profit">+$2,681</td>
                            <td class="mono">92</td>
                            <td class="mono">61.2%</td>
                            <td class="mono profit">+$29</td>
                            <td class="mono profit">+$847</td>
                            <td class="mono loss">-$512</td>
                            <td class="mono">1.42</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Risk Analysis Tab -->
        <div class="tab-content" id="risk">
            <!-- Risk Metrics -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Value at Risk (95%)</div>
                    <div class="metric-value mono loss">-$3,847</div>
                    <div class="metric-change mono">Daily VaR</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Expected Shortfall</div>
                    <div class="metric-value mono loss">-$4,923</div>
                    <div class="metric-change mono">CVaR 95%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Beta to BTC</div>
                    <div class="metric-value mono">1.24</div>
                    <div class="metric-change mono">30-day rolling</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Beta to ETH</div>
                    <div class="metric-value mono">0.87</div>
                    <div class="metric-change mono">30-day rolling</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Leverage Utilization</div>
                    <div class="metric-value mono">3.2x</div>
                    <div class="risk-bar">
                        <div class="risk-bar-fill" style="width: 32%;"></div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Margin Call Risk</div>
                    <div class="metric-value mono warning">Medium</div>
                    <div class="risk-bar">
                        <div class="risk-bar-fill warning" style="width: 45%;"></div>
                    </div>
                </div>
            </div>

            <!-- Liquidation Analysis -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Liquidation Risk Analysis</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>POSITION</th>
                            <th>SIZE</th>
                            <th>LEVERAGE</th>
                            <th>ENTRY</th>
                            <th>MARK</th>
                            <th>LIQ PRICE</th>
                            <th>DISTANCE</th>
                            <th>RISK SCORE</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>BTC-USD LONG</td>
                            <td class="mono">1.5</td>
                            <td class="mono">5x</td>
                            <td class="mono">67,420</td>
                            <td class="mono">69,183</td>
                            <td class="mono loss">58,947</td>
                            <td class="mono">14.8%</td>
                            <td class="mono warning">MEDIUM</td>
                        </tr>
                        <tr>
                            <td>ETH-USD LONG</td>
                            <td class="mono">12.0</td>
                            <td class="mono">4x</td>
                            <td class="mono">3,420</td>
                            <td class="mono">3,485</td>
                            <td class="mono loss">2,987</td>
                            <td class="mono">14.3%</td>
                            <td class="mono warning">MEDIUM</td>
                        </tr>
                        <tr>
                            <td>SOL-USD SHORT</td>
                            <td class="mono">250</td>
                            <td class="mono">3x</td>
                            <td class="mono">178.50</td>
                            <td class="mono">176.25</td>
                            <td class="mono loss">195.35</td>
                            <td class="mono">10.8%</td>
                            <td class="mono loss">HIGH</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Correlation Matrix -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Position Correlation Matrix</div>
                </div>
                <div class="correlation-matrix">
                    <div class="correlation-cell">1.00</div>
                    <div class="correlation-cell">0.78</div>
                    <div class="correlation-cell">0.62</div>
                    <div class="correlation-cell">0.45</div>
                    <div class="correlation-cell">-0.23</div>
                    <div class="correlation-cell">0.78</div>
                    <div class="correlation-cell">1.00</div>
                    <div class="correlation-cell">0.71</div>
                    <div class="correlation-cell">0.53</div>
                    <div class="correlation-cell">-0.18</div>
                    <div class="correlation-cell">0.62</div>
                    <div class="correlation-cell">0.71</div>
                    <div class="correlation-cell">1.00</div>
                    <div class="correlation-cell">0.67</div>
                    <div class="correlation-cell">-0.31</div>
                    <div class="correlation-cell">0.45</div>
                    <div class="correlation-cell">0.53</div>
                    <div class="correlation-cell">0.67</div>
                    <div class="correlation-cell">1.00</div>
                    <div class="correlation-cell">-0.15</div>
                    <div class="correlation-cell">-0.23</div>
                    <div class="correlation-cell">-0.18</div>
                    <div class="correlation-cell">-0.31</div>
                    <div class="correlation-cell">-0.15</div>
                    <div class="correlation-cell">1.00</div>
                </div>
            </div>

            <!-- Historical Drawdowns -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Historical Drawdown Periods</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>PERIOD</th>
                            <th>DEPTH</th>
                            <th>DURATION</th>
                            <th>RECOVERY</th>
                            <th>PEAK VALUE</th>
                            <th>TROUGH VALUE</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Mar 12-18, 2024</td>
                            <td class="mono loss">-18.7%</td>
                            <td class="mono">6 days</td>
                            <td class="mono">4 days</td>
                            <td class="mono">$45,000</td>
                            <td class="mono">$36,580</td>
                        </tr>
                        <tr>
                            <td>Feb 3-8, 2024</td>
                            <td class="mono loss">-11.2%</td>
                            <td class="mono">5 days</td>
                            <td class="mono">3 days</td>
                            <td class="mono">$32,100</td>
                            <td class="mono">$28,505</td>
                        </tr>
                        <tr>
                            <td>Jan 15-17, 2024</td>
                            <td class="mono loss">-6.7%</td>
                            <td class="mono">2 days</td>
                            <td class="mono">1 day</td>
                            <td class="mono">$18,470</td>
                            <td class="mono">$17,232</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Positions Tab -->
        <div class="tab-content" id="positions">
            <!-- Position Analytics -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Active Positions</div>
                    <div class="metric-value mono">4</div>
                    <div class="metric-change mono">$127,420 notional</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Avg Entry Efficiency</div>
                    <div class="metric-value mono">94.3%</div>
                    <div class="metric-change mono">vs limit price</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Avg Exit Efficiency</div>
                    <div class="metric-value mono">91.8%</div>
                    <div class="metric-change mono">vs target</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Slippage Cost</div>
                    <div class="metric-value mono loss">-$1,847</div>
                    <div class="metric-change mono">MTD total</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Fill Rate</div>
                    <div class="metric-value mono">87.2%</div>
                    <div class="metric-change mono">Limit orders</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">VWAP Performance</div>
                    <div class="metric-value mono profit">+2.3%</div>
                    <div class="metric-change mono">vs market VWAP</div>
                </div>
            </div>

            <!-- Recent Trades -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Recent Position History</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>TIME</th>
                            <th>ASSET</th>
                            <th>SIDE</th>
                            <th>SIZE</th>
                            <th>ENTRY</th>
                            <th>EXIT</th>
                            <th>P&L</th>
                            <th>P&L %</th>
                            <th>DURATION</th>
                            <th>FUNDING</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="mono">2h ago</td>
                            <td class="mono">BTC-USD</td>
                            <td class="mono">LONG</td>
                            <td class="mono">0.5</td>
                            <td class="mono">68,920</td>
                            <td class="mono">69,284</td>
                            <td class="mono profit">+$182</td>
                            <td class="mono profit">+0.53%</td>
                            <td class="mono">1h 23m</td>
                            <td class="mono loss">-$8.47</td>
                        </tr>
                        <tr>
                            <td class="mono">5h ago</td>
                            <td class="mono">ETH-USD</td>
                            <td class="mono">SHORT</td>
                            <td class="mono">8.0</td>
                            <td class="mono">3,512</td>
                            <td class="mono">3,487</td>
                            <td class="mono profit">+$200</td>
                            <td class="mono profit">+0.71%</td>
                            <td class="mono">2h 47m</td>
                            <td class="mono profit">+$12.30</td>
                        </tr>
                        <tr>
                            <td class="mono">8h ago</td>
                            <td class="mono">SOL-USD</td>
                            <td class="mono">LONG</td>
                            <td class="mono">150</td>
                            <td class="mono">174.20</td>
                            <td class="mono">173.85</td>
                            <td class="mono loss">-$52.50</td>
                            <td class="mono loss">-0.20%</td>
                            <td class="mono">45m</td>
                            <td class="mono loss">-$3.20</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Hold Time Analysis -->
            <div class="two-column">
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Hold Time Distribution</div>
                    </div>
                    <div class="distribution-bars" id="holdTimeDistribution"></div>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Position Size Distribution</div>
                    </div>
                    <div class="distribution-bars" id="sizeDistribution"></div>
                </div>
            </div>
        </div>

        <!-- Behavior Tab -->
        <div class="tab-content" id="behavior">
            <!-- Behavioral Scores -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Discipline Score</div>
                    <div class="metric-value mono">87/100</div>
                    <div class="metric-change mono profit">↑ 5 pts this week</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Stop Loss Adherence</div>
                    <div class="metric-value mono">92.3%</div>
                    <div class="metric-change mono">38/41 honored</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Revenge Trading</div>
                    <div class="metric-value mono warning">2</div>
                    <div class="metric-change mono">Instances this month</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">FOMO Entries</div>
                    <div class="metric-value mono warning">5</div>
                    <div class="metric-change mono loss">Cost: -$847</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Overtrading Score</div>
                    <div class="metric-value mono profit">Low</div>
                    <div class="metric-change mono">4.2 trades/day avg</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Scaling Efficiency</div>
                    <div class="metric-value mono">78.4%</div>
                    <div class="metric-change mono">In/out effectiveness</div>
                </div>
            </div>

            <!-- Pattern Recognition -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Detected Trading Patterns</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>PATTERN</th>
                            <th>FREQUENCY</th>
                            <th>SUCCESS RATE</th>
                            <th>AVG P&L</th>
                            <th>RECOMMENDATION</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Morning Breakout (08:00-10:00)</td>
                            <td class="mono">47</td>
                            <td class="mono profit">74.5%</td>
                            <td class="mono profit">+$287</td>
                            <td style="color: var(--profit)">CONTINUE</td>
                        </tr>
                        <tr>
                            <td>Post-Loss Double Down</td>
                            <td class="mono">12</td>
                            <td class="mono loss">33.3%</td>
                            <td class="mono loss">-$423</td>
                            <td style="color: var(--loss)">AVOID</td>
                        </tr>
                        <tr>
                            <td>Friday Afternoon Trades</td>
                            <td class="mono">23</td>
                            <td class="mono loss">43.5%</td>
                            <td class="mono loss">-$127</td>
                            <td style="color: var(--warning)">REDUCE</td>
                        </tr>
                        <tr>
                            <td>Trend Following (>4h)</td>
                            <td class="mono">31</td>
                            <td class="mono profit">80.6%</td>
                            <td class="mono profit">+$512</td>
                            <td style="color: var(--profit)">INCREASE</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Trading Activity Heatmap -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Trading Activity by Hour/Day</div>
                    <div class="mono" style="font-size: 11px; color: var(--text-tertiary);">INTENSITY MAP</div>
                </div>
                <div class="heatmap" id="activityHeatmap"></div>
            </div>
        </div>

        <!-- Market Structure Tab -->
        <div class="tab-content" id="market">
            <!-- Market Microstructure Metrics -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Funding Captured</div>
                    <div class="metric-value mono profit">+$2,847</div>
                    <div class="metric-change mono">30-day total</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Funding Paid</div>
                    <div class="metric-value mono loss">-$1,293</div>
                    <div class="metric-change mono">30-day total</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Net Funding</div>
                    <div class="metric-value mono profit">+$1,554</div>
                    <div class="metric-change mono profit">+3.3% of P&L</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Basis Arbitrage</div>
                    <div class="metric-value mono profit">+$847</div>
                    <div class="metric-change mono">4 opportunities</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Spread Captured</div>
                    <div class="metric-value mono">42.3%</div>
                    <div class="metric-change mono">Maker orders</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Book Imbalance Win</div>
                    <div class="metric-value mono">67.8%</div>
                    <div class="metric-change mono">At entry</div>
                </div>
            </div>

            <!-- Funding Rate Analysis -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Funding Rate Analysis by Asset</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ASSET</th>
                            <th>AVG RATE</th>
                            <th>CURRENT</th>
                            <th>PREDICTED</th>
                            <th>RECEIVED</th>
                            <th>PAID</th>
                            <th>NET</th>
                            <th>STRATEGY</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>BTC-USD</td>
                            <td class="mono">0.012%</td>
                            <td class="mono loss">-0.018%</td>
                            <td class="mono">0.008%</td>
                            <td class="mono profit">+$1,247</td>
                            <td class="mono loss">-$423</td>
                            <td class="mono profit">+$824</td>
                            <td style="color: var(--profit)">LONG BIAS</td>
                        </tr>
                        <tr>
                            <td>ETH-USD</td>
                            <td class="mono">0.008%</td>
                            <td class="mono profit">0.014%</td>
                            <td class="mono">0.011%</td>
                            <td class="mono profit">+$847</td>
                            <td class="mono loss">-$512</td>
                            <td class="mono profit">+$335</td>
                            <td style="color: var(--warning)">NEUTRAL</td>
                        </tr>
                        <tr>
                            <td>SOL-USD</td>
                            <td class="mono">0.024%</td>
                            <td class="mono profit">0.032%</td>
                            <td class="mono">0.027%</td>
                            <td class="mono profit">+$623</td>
                            <td class="mono loss">-$287</td>
                            <td class="mono profit">+$336</td>
                            <td style="color: var(--loss)">SHORT BIAS</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Order Book Analysis -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Order Book Imbalance at Entry</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>IMBALANCE RANGE</th>
                            <th>TRADES</th>
                            <th>WIN RATE</th>
                            <th>AVG P&L</th>
                            <th>EFFECTIVENESS</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>>70% Buy</td>
                            <td class="mono">47</td>
                            <td class="mono profit">78.7%</td>
                            <td class="mono profit">+$342</td>
                            <td style="color: var(--profit)">HIGH</td>
                        </tr>
                        <tr>
                            <td>50-70% Buy</td>
                            <td class="mono">62</td>
                            <td class="mono">68.2%</td>
                            <td class="mono profit">+$187</td>
                            <td style="color: var(--profit)">GOOD</td>
                        </tr>
                        <tr>
                            <td>Balanced</td>
                            <td class="mono">124</td>
                            <td class="mono">52.4%</td>
                            <td class="mono profit">+$23</td>
                            <td style="color: var(--warning)">NEUTRAL</td>
                        </tr>
                        <tr>
                            <td>50-70% Sell</td>
                            <td class="mono">58</td>
                            <td class="mono">71.3%</td>
                            <td class="mono profit">+$214</td>
                            <td style="color: var(--profit)">GOOD</td>
                        </tr>
                        <tr>
                            <td>>70% Sell</td>
                            <td class="mono">41</td>
                            <td class="mono profit">75.6%</td>
                            <td class="mono profit">+$298</td>
                            <td style="color: var(--profit)">HIGH</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Command Palette Hint -->
        <div class="cmd-hint">
            Press <span class="key">⌘</span><span class="key">K</span> for commands • <span class="key">Tab</span> to navigate
        </div>
    </div>

    <script>
        // Tab Navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active from all tabs and contents
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active to clicked tab and corresponding content
                this.classList.add('active');
                const tabId = this.dataset.tab;
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Generate distribution bars
        function generateDistribution(containerId, count = 30) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            for (let i = 0; i < count; i++) {
                const bar = document.createElement('div');
                bar.className = 'distribution-bar';
                const height = Math.random() * 80 + 20;
                bar.style.height = `${height}%`;
                
                // Color based on value
                if (i < count * 0.3) {
                    bar.style.background = 'var(--loss)';
                    bar.style.opacity = '0.3';
                } else if (i > count * 0.7) {
                    bar.style.background = 'var(--profit)';
                    bar.style.opacity = '0.3';
                }
                
                container.appendChild(bar);
            }
        }

        // Generate heatmap
        function generateHeatmap(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            for (let i = 0; i < 168; i++) {
                const cell = document.createElement('div');
                cell.className = 'heatmap-cell';
                const intensity = Math.random();
                cell.style.backgroundColor = `rgba(255, 255, 255, ${intensity * 0.3})`;
                container.appendChild(cell);
            }
        }

        // Initialize visualizations
        generateDistribution('winLossDistribution');
        generateDistribution('holdTimeDistribution', 24);
        generateDistribution('sizeDistribution', 20);
        generateHeatmap('activityHeatmap');

        // Time selector functionality
        document.querySelectorAll('.time-option').forEach(option => {
            option.addEventListener('click', function() {
                const parent = this.parentElement;
                parent.querySelectorAll('.time-option').forEach(o => o.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Copy address on click
        document.querySelector('.address').addEventListener('click', function() {
            navigator.clipboard.writeText('dydx1agxtmjdgw7nrgs7m086m3qse7hwyf54gfeampv');
            const original = this.textContent;
            this.textContent = 'Copied!';
            setTimeout(() => {
                this.textContent = original;
            }, 1500);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Command palette
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                alert('Command palette would open here');
            }
            
            // Tab navigation with number keys
            if (e.key >= '1' && e.key <= '6') {
                const tabIndex = parseInt(e.key) - 1;
                const tabs = document.querySelectorAll('.nav-tab');
                if (tabs[tabIndex]) {
                    tabs[tabIndex].click();
                }
            }
        });

        // dYdX API Configuration
        const DYDX_API = 'https://indexer.dydx.trade/v4';
        let currentAddress = null;
        let allData = {};

        // Format functions
        function formatCurrency(value) {
            if (value === null || value === undefined || isNaN(value)) return '-';
            const absValue = Math.abs(value);
            const sign = value >= 0 ? '+' : '-';
            
            if (absValue >= 1000000) {
                return sign + '$' + (absValue / 1000000).toFixed(2) + 'M';
            } else if (absValue >= 1000) {
                return sign + '$' + (absValue / 1000).toFixed(2) + 'K';
            } else {
                return sign + '$' + absValue.toFixed(2);
            }
        }

        function formatPercent(value) {
            if (value === null || value === undefined || isNaN(value)) return '-';
            return value.toFixed(1) + '%';
        }

        // Load real dashboard data
        async function loadDashboard() {
            // Get address from URL params
            const urlParams = new URLSearchParams(window.location.search);
            const address = urlParams.get('address') || 'dydx1agxtmjdgw7nrgs7m086m3qse7hwyf54gfeampv';
            
            if (!address) return;

            currentAddress = address;

            try {
                // Fetch data using CORRECT endpoint structure from docs
                const [
                    subaccountRes, 
                    openPositionsRes, 
                    closedPositionsRes, 
                    ordersRes, 
                    fillsRes
                ] = await Promise.all([
                    fetch(`${DYDX_API}/addresses/${address}/subaccountNumber/0`),
                    // Get OPEN positions
                    fetch(`${DYDX_API}/addresses/${address}/subaccountNumber/0/perpetualPositions?status=OPEN&limit=100`),
                    // Get CLOSED positions - this is what we were missing!
                    fetch(`${DYDX_API}/addresses/${address}/subaccountNumber/0/perpetualPositions?status=CLOSED&limit=100`),
                    // Get orders
                    fetch(`${DYDX_API}/addresses/${address}/subaccountNumber/0/orders?limit=100`),
                    // Get fills
                    fetch(`${DYDX_API}/addresses/${address}/subaccountNumber/0/fills?limit=100`)
                ]);

                const subaccountData = await subaccountRes.json();
                const openPositionsData = await openPositionsRes.json();
                const closedPositionsData = await closedPositionsRes.json();
                const ordersData = await ordersRes.json();
                const fillsData = await fillsRes.json();

                allData = {
                    subaccount: subaccountData,
                    openPositions: openPositionsData,
                    closedPositions: closedPositionsData,
                    orders: ordersData,
                    fills: fillsData
                };

                // Process and display data
                processData();

            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Process real data
        function processData() {
            console.log('Processing data:', allData);
            
            // Get subaccount data
            const subaccount = allData.subaccount?.subaccount;
            
            // Get ALL positions (both open and closed)
            let allPositions = [];
            
            // Add open positions
            if (allData.openPositions?.positions) {
                allPositions = allPositions.concat(allData.openPositions.positions);
            }
            
            // Add closed positions - THIS IS THE KEY FIX!
            if (allData.closedPositions?.positions) {
                allPositions = allPositions.concat(allData.closedPositions.positions);
            }
            
            console.log('Open positions:', allData.openPositions?.positions?.length || 0);
            console.log('Closed positions:', allData.closedPositions?.positions?.length || 0);
            
            // Calculate P&L from positions and fills
            let totalUnrealizedPnL = 0;
            let totalRealizedPnL = 0;
            let openPositionCount = 0;
            
            // Calculate from positions
            allPositions.forEach(pos => {
                if (pos.status === 'OPEN') {
                    totalUnrealizedPnL += parseFloat(pos.unrealizedPnl || 0);
                    openPositionCount++;
                }
                totalRealizedPnL += parseFloat(pos.realizedPnl || 0);
            });
            
            // Calculate win/loss statistics from CLOSED positions
            let wins = 0;
            let losses = 0;
            let totalWinAmount = 0;
            let totalLossAmount = 0;
            
            // Process closed positions to calculate win/loss
            allPositions.forEach(pos => {
                if (pos.status === 'CLOSED') {
                    const realizedPnl = parseFloat(pos.realizedPnl || 0);
                    if (realizedPnl > 0) {
                        wins++;
                        totalWinAmount += realizedPnl;
                    } else if (realizedPnl < 0) {
                        losses++;
                        totalLossAmount += Math.abs(realizedPnl);
                    }
                }
            });
            
            console.log('Wins:', wins, 'Losses:', losses);
            console.log('Total win amount:', totalWinAmount, 'Total loss amount:', totalLossAmount);
            
            // Track market distribution for Trading Activity chart
            const marketDistribution = {};
            allPositions.forEach(pos => {
                const market = pos.market || 'Unknown';
                if (!marketDistribution[market]) {
                    marketDistribution[market] = {
                        tradeCount: 0,
                        totalPnL: 0,
                        openCount: 0
                    };
                }
                marketDistribution[market].tradeCount++;
                marketDistribution[market].totalPnL += parseFloat(pos.realizedPnl || 0) + parseFloat(pos.unrealizedPnl || 0);
                if (pos.status === 'OPEN') {
                    marketDistribution[market].openCount++;
                }
            });
            
            console.log('Market distribution:', marketDistribution);
            
            // Create Trading Activity Chart
            createMarketDistributionChart(marketDistribution);
            
            // Calculate total P&L
            const totalPnL = totalUnrealizedPnL + totalRealizedPnL;
            
            // Calculate derived metrics
            const totalTrades = wins + losses;
            const winRate = totalTrades > 0 ? (wins / totalTrades) * 100 : 0;
            const profitFactor = totalLossAmount > 0 ? totalWinAmount / totalLossAmount : 0;
            const avgWin = wins > 0 ? totalWinAmount / wins : 0;
            const avgLoss = losses > 0 ? totalLossAmount / losses : 0;

            // Update ALL metric cards with real data
            updateMetric('totalPnL', formatCurrency(totalPnL), totalPnL >= 0);
            document.getElementById('totalPnLChange').textContent = 'All Time';
            
            // Show win rate or N/A if no trades
            if (totalTrades > 0) {
                document.getElementById('winRate').textContent = formatPercent(winRate);
                document.getElementById('winRateDetail').textContent = `${wins} / ${totalTrades} trades`;
            } else {
                document.getElementById('winRate').textContent = 'N/A';
                document.getElementById('winRateDetail').textContent = 'No closed trades';
            }
            
            // Profit factor
            if (totalLossAmount > 0) {
                document.getElementById('profitFactor').textContent = profitFactor.toFixed(2);
                document.getElementById('profitFactorDetail').textContent = 
                    `${formatCurrency(totalWinAmount)} / ${formatCurrency(totalLossAmount)}`;
            } else {
                document.getElementById('profitFactor').textContent = 'N/A';
                document.getElementById('profitFactorDetail').textContent = 'No losses recorded';
            }
            
            // These would need historical data to calculate properly
            document.getElementById('sharpeRatio').textContent = 'N/A';
            document.getElementById('sortinoRatio').textContent = 'N/A';
            document.getElementById('maxDrawdown').textContent = formatPercent(Math.abs(totalPnL / parseFloat(subaccount?.equity || 1)) * 100);
            document.getElementById('maxDrawdownDetail').textContent = 'From equity';

            // Update Trading Statistics section
            updateElement('avgWin', wins > 0 ? formatCurrency(avgWin) : 'N/A');
            updateElement('avgLoss', losses > 0 ? formatCurrency(avgLoss) : 'N/A');
            updateElement('riskReward', avgLoss > 0 ? `1:${(avgWin/avgLoss).toFixed(2)}` : 'N/A');
            updateElement('expectancy', totalTrades > 0 ? formatCurrency(totalPnL/totalTrades) : 'N/A');
            updateElement('recoveryFactor', 'N/A');
            
            // Show actual account equity
            if (subaccount) {
                console.log('Account equity:', subaccount.equity);
                console.log('Free collateral:', subaccount.freeCollateral);
                console.log('Open positions:', openPositionCount);
            }
        }

        function updateMetric(id, value, isPositive = true) {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = value;
                el.className = isPositive ? 'metric-value mono profit' : 'metric-value mono loss';
            }
        }

        function updateElement(id, value) {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        }

        let marketChart = null;
        function createMarketDistributionChart(marketDistribution) {
            const ctx = document.getElementById('marketDistributionChart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (marketChart) {
                marketChart.destroy();
            }
            
            // Sort markets by trade count and take top 5
            const sortedMarkets = Object.entries(marketDistribution)
                .sort((a, b) => b[1].tradeCount - a[1].tradeCount)
                .slice(0, 5);
            
            if (sortedMarkets.length === 0) {
                // No data to display
                return;
            }
            
            const labels = sortedMarkets.map(([market, data]) => 
                `${market} (${data.tradeCount})`
            );
            const data = sortedMarkets.map(([_, data]) => data.tradeCount);
            const backgroundColors = [
                '#10B981', // Green
                '#3B82F6', // Blue  
                '#F59E0B', // Yellow
                '#EF4444', // Red
                '#8B5CF6'  // Purple
            ];
            
            marketChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: 'var(--bg-primary)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: 'var(--text-secondary)',
                                padding: 15,
                                font: {
                                    size: 11
                                },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return {
                                            text: `${label} - ${percentage}%`,
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            index: i
                                        };
                                    });
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'var(--bg-elevated)',
                            titleColor: 'var(--text-primary)',
                            bodyColor: 'var(--text-secondary)',
                            borderColor: 'var(--border)',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const market = sortedMarkets[context.dataIndex];
                                    const lines = [
                                        `Trades: ${market[1].tradeCount}`,
                                        `Total P&L: ${formatCurrency(market[1].totalPnL)}`,
                                        `Open Positions: ${market[1].openCount}`
                                    ];
                                    return lines;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Auto-load real data on page load
        window.addEventListener('load', loadDashboard);
    </script>
</body>
