<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dYdX Analytics v3.0.1 - Fixed</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="breadcrumb">ANALYTICS / OVERVIEW</div>
            <div class="header-right">
                <span class="status-badge live">LIVE</span>
                <div class="address mono" id="addressDisplay">Not Connected</div>
            </div>
        </div>

        <!-- Address Input Section -->
        <div style="background: var(--bg-secondary); padding: 20px; margin-bottom: 24px;">
            <div style="display: flex; gap: 16px; align-items: center;">
                <input type="text" 
                       id="addressInput" 
                       placeholder="Enter dYdX address (e.g., dydx1...)" 
                       value="dydx1agxtmjdgw7nrgs7m086m3qse7hwyf54gfeampv"
                       style="flex: 1; background: var(--bg-elevated); border: 1px solid var(--border); 
                              color: var(--text-primary); padding: 12px; font-family: 'JetBrains Mono', monospace;">
                <button id="loadDashboard" 
                        onclick="loadDashboard()"
                        style="padding: 12px 24px; background: var(--text-primary); color: var(--bg-primary);
                               border: none; cursor: pointer; font-weight: 600; text-transform: uppercase;">
                    Load Dashboard
                </button>
            </div>
        </div>

        <!-- Debug Info -->
        <div id="debugInfo" style="background: var(--bg-secondary); padding: 16px; margin-bottom: 24px; display: none;">
            <div style="font-size: 11px; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace;">
                <div id="debugContent"></div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="overview">OVERVIEW</div>
            <div class="nav-tab" data-tab="positions">POSITIONS</div>
            <div class="nav-tab" data-tab="fills">FILLS</div>
            <div class="nav-tab" data-tab="funding">FUNDING</div>
            <div class="nav-tab" data-tab="pnl">HISTORICAL P&L</div>
        </div>

        <!-- Loading State -->
        <div id="loader" class="loading" style="display: none;">
            <div class="spinner"></div>
            <div style="margin-top: 16px;">Loading portfolio data...</div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <!-- Overview Tab -->
        <div class="tab-content active" id="overview">
            <!-- Primary Metrics -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Equity</div>
                    <div class="metric-value mono" id="equity">-</div>
                    <div class="metric-change mono" id="equityChange">USD Value</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Free Collateral</div>
                    <div class="metric-value mono" id="freeCollateral">-</div>
                    <div class="metric-change mono">Available</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Margin Usage</div>
                    <div class="metric-value mono" id="marginUsage">-</div>
                    <div class="metric-change mono">Utilization</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Open Positions</div>
                    <div class="metric-value mono" id="openPositionCount">-</div>
                    <div class="metric-change mono">Active</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Realized P&L</div>
                    <div class="metric-value mono" id="totalRealizedPnl">-</div>
                    <div class="metric-change mono">All Time</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Unrealized P&L</div>
                    <div class="metric-value mono" id="totalUnrealizedPnl">-</div>
                    <div class="metric-change mono">Current</div>
                </div>
            </div>

            <!-- Account Details -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Account Details</div>
                </div>
                <table>
                    <tbody id="accountDetailsTable">
                        <tr><td colspan="2" style="text-align: center;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Positions Tab -->
        <div class="tab-content" id="positions">
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">All Positions</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>MARKET</th>
                            <th>STATUS</th>
                            <th>SIDE</th>
                            <th>SIZE</th>
                            <th>ENTRY PRICE</th>
                            <th>EXIT PRICE</th>
                            <th>REALIZED P&L</th>
                            <th>UNREALIZED P&L</th>
                            <th>NET FUNDING</th>
                        </tr>
                    </thead>
                    <tbody id="positionsTableBody">
                        <tr><td colspan="9" style="text-align: center;">No data loaded</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Fills Tab -->
        <div class="tab-content" id="fills">
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Recent Fills (Trades)</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>TIME</th>
                            <th>MARKET</th>
                            <th>SIDE</th>
                            <th>TYPE</th>
                            <th>SIZE</th>
                            <th>PRICE</th>
                            <th>FEE</th>
                            <th>LIQUIDITY</th>
                        </tr>
                    </thead>
                    <tbody id="fillsTableBody">
                        <tr><td colspan="8" style="text-align: center;">No data loaded</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Funding Tab -->
        <div class="tab-content" id="funding">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Total Funding Received</div>
                    <div class="metric-value mono profit" id="fundingReceived">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Funding Paid</div>
                    <div class="metric-value mono loss" id="fundingPaid">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Net Funding</div>
                    <div class="metric-value mono" id="netFunding">-</div>
                </div>
            </div>
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Recent Funding Payments</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>TIME</th>
                            <th>MARKET</th>
                            <th>PAYMENT</th>
                            <th>RATE</th>
                            <th>POSITION SIZE</th>
                        </tr>
                    </thead>
                    <tbody id="fundingTableBody">
                        <tr><td colspan="5" style="text-align: center;">No data loaded</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Historical P&L Tab -->
        <div class="tab-content" id="pnl">
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Historical P&L (Daily)</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>DATE</th>
                            <th>EQUITY</th>
                            <th>TOTAL P&L</th>
                            <th>NET TRANSFERS</th>
                        </tr>
                    </thead>
                    <tbody id="pnlTableBody">
                        <tr><td colspan="4" style="text-align: center;">No data loaded</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const DYDX_API = 'https://indexer.dydx.trade/v4';
        let currentAddress = null;
        let allData = {};

        // Tab navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                const tabId = this.dataset.tab;
                document.getElementById(tabId)?.classList.add('active');
            });
        });

        // Format functions
        function formatCurrency(value) {
            if (value === null || value === undefined || isNaN(value)) return '-';
            const absValue = Math.abs(value);
            const sign = value >= 0 ? '+' : '-';
            
            if (absValue >= 1000000) {
                return sign + '$' + (absValue / 1000000).toFixed(2) + 'M';
            } else if (absValue >= 1000) {
                return sign + '$' + (absValue / 1000).toFixed(2) + 'K';
            } else {
                return sign + '$' + absValue.toFixed(2);
            }
        }

        function formatNumber(value, decimals = 2) {
            if (value === null || value === undefined || isNaN(value)) return '-';
            return value.toFixed(decimals);
        }

        function formatPercent(value) {
            if (value === null || value === undefined || isNaN(value)) return '-';
            return value.toFixed(2) + '%';
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        // Show debug info
        function showDebug(message) {
            const debugEl = document.getElementById('debugInfo');
            const contentEl = document.getElementById('debugContent');
            debugEl.style.display = 'block';
            contentEl.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
        }

        // Load dashboard
        async function loadDashboard() {
            const address = document.getElementById('addressInput').value.trim();
            if (!address) {
                showError('Please enter a valid dYdX address');
                return;
            }

            currentAddress = address;
            showLoading(true);
            hideError();
            
            // Clear debug
            document.getElementById('debugContent').innerHTML = '';

            try {
                // Update address display
                document.getElementById('addressDisplay').textContent = 
                    address.slice(0, 8) + '...' + address.slice(-4);

                showDebug('Fetching account data...');
                
                // Fetch all data endpoints
                const [accountRes, positionsRes, fillsRes, fundingRes, historicalPnlRes] = await Promise.all([
                    fetch(`${DYDX_API}/addresses/${address}/subaccountNumber/0`),
                    fetch(`${DYDX_API}/perpetualPositions?address=${address}&subaccountNumber=0&limit=100`),
                    fetch(`${DYDX_API}/fills?address=${address}&subaccountNumber=0&limit=100`),
                    fetch(`${DYDX_API}/fundingPayments?address=${address}&subaccountNumber=0&limit=100`),
                    fetch(`${DYDX_API}/historical-pnl?address=${address}&subaccountNumber=0&limit=90`)
                ]);

                // Parse all responses
                const accountData = await accountRes.json();
                const positionsData = await positionsRes.json();
                const fillsData = await fillsRes.json();
                const fundingData = await fundingRes.json();
                const historicalPnlData = await historicalPnlRes.json();

                // Store all data
                allData = {
                    account: accountData,
                    positions: positionsData,
                    fills: fillsData,
                    funding: fundingData,
                    historicalPnl: historicalPnlData
                };

                showDebug(`Account data: ${accountData.subaccount ? 'Found' : 'Not found'}`);
                showDebug(`Positions: ${positionsData.positions?.length || 0} found`);
                showDebug(`Fills: ${fillsData.fills?.length || 0} found`);
                showDebug(`Funding payments: ${fundingData.fundingPayments?.length || 0} found`);
                showDebug(`Historical P&L: ${historicalPnlData.historicalPnl?.length || 0} days`);

                // Process all data
                processAllData();

                showLoading(false);
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showError('Failed to load data: ' + error.message);
                showDebug('Error: ' + error.message);
                showLoading(false);
            }
        }

        // Process all data
        function processAllData() {
            // Process account
            if (allData.account?.subaccount) {
                const sub = allData.account.subaccount;
                
                // Update metrics
                document.getElementById('equity').textContent = formatCurrency(parseFloat(sub.equity || 0));
                document.getElementById('freeCollateral').textContent = formatCurrency(parseFloat(sub.freeCollateral || 0));
                document.getElementById('marginUsage').textContent = formatPercent(parseFloat(sub.marginUsage || 0) * 100);
                
                // Build account details table
                const detailsHtml = Object.entries(sub).map(([key, value]) => {
                    if (typeof value === 'object') return '';
                    return `
                        <tr>
                            <td style="color: var(--text-secondary)">${key}</td>
                            <td class="mono">${value}</td>
                        </tr>
                    `;
                }).join('');
                
                document.getElementById('accountDetailsTable').innerHTML = detailsHtml || '<tr><td>No account data</td></tr>';
            }

            // Process positions
            if (allData.positions?.positions) {
                const positions = allData.positions.positions;
                
                // Count open positions and calculate P&L
                let openCount = 0;
                let totalRealized = 0;
                let totalUnrealized = 0;
                
                const positionsHtml = positions.map(pos => {
                    if (pos.status === 'OPEN') openCount++;
                    
                    const realized = parseFloat(pos.realizedPnl || 0);
                    const unrealized = parseFloat(pos.unrealizedPnl || 0);
                    totalRealized += realized;
                    totalUnrealized += unrealized;
                    
                    return `
                        <tr>
                            <td>${pos.market}</td>
                            <td>${pos.status}</td>
                            <td class="${pos.side === 'LONG' ? 'profit' : 'loss'}">${pos.side}</td>
                            <td class="mono">${formatNumber(Math.abs(parseFloat(pos.size || 0)))}</td>
                            <td class="mono">${formatCurrency(parseFloat(pos.entryPrice || 0))}</td>
                            <td class="mono">${pos.exitPrice ? formatCurrency(parseFloat(pos.exitPrice)) : '-'}</td>
                            <td class="mono ${realized > 0 ? 'profit' : realized < 0 ? 'loss' : ''}">${formatCurrency(realized)}</td>
                            <td class="mono ${unrealized > 0 ? 'profit' : unrealized < 0 ? 'loss' : ''}">${formatCurrency(unrealized)}</td>
                            <td class="mono">${formatCurrency(parseFloat(pos.netFunding || 0))}</td>
                        </tr>
                    `;
                }).join('');
                
                document.getElementById('positionsTableBody').innerHTML = positionsHtml || '<tr><td colspan="9">No positions</td></tr>';
                document.getElementById('openPositionCount').textContent = openCount;
                document.getElementById('totalRealizedPnl').textContent = formatCurrency(totalRealized);
                document.getElementById('totalUnrealizedPnl').textContent = formatCurrency(totalUnrealized);
                
                // Add color classes
                if (totalRealized > 0) document.getElementById('totalRealizedPnl').classList.add('profit');
                else if (totalRealized < 0) document.getElementById('totalRealizedPnl').classList.add('loss');
                
                if (totalUnrealized > 0) document.getElementById('totalUnrealizedPnl').classList.add('profit');
                else if (totalUnrealized < 0) document.getElementById('totalUnrealizedPnl').classList.add('loss');
            }

            // Process fills
            if (allData.fills?.fills) {
                const fills = allData.fills.fills;
                
                const fillsHtml = fills.slice(0, 50).map(fill => `
                    <tr>
                        <td>${formatDateTime(fill.createdAt)}</td>
                        <td>${fill.market}</td>
                        <td class="${fill.side === 'BUY' ? 'profit' : 'loss'}">${fill.side}</td>
                        <td>${fill.type}</td>
                        <td class="mono">${formatNumber(parseFloat(fill.size || 0))}</td>
                        <td class="mono">${formatCurrency(parseFloat(fill.price || 0))}</td>
                        <td class="mono">${formatCurrency(parseFloat(fill.fee || 0))}</td>
                        <td>${fill.liquidity}</td>
                    </tr>
                `).join('');
                
                document.getElementById('fillsTableBody').innerHTML = fillsHtml || '<tr><td colspan="8">No fills</td></tr>';
            }

            // Process funding
            if (allData.funding?.fundingPayments) {
                const payments = allData.funding.fundingPayments;
                
                let totalReceived = 0;
                let totalPaid = 0;
                
                const fundingHtml = payments.slice(0, 20).map(payment => {
                    const amount = parseFloat(payment.payment || 0);
                    
                    if (amount > 0) totalReceived += amount;
                    else totalPaid += Math.abs(amount);
                    
                    return `
                        <tr>
                            <td>${formatDateTime(payment.effectiveAt)}</td>
                            <td>${payment.market}</td>
                            <td class="mono ${amount > 0 ? 'profit' : 'loss'}">${formatCurrency(amount)}</td>
                            <td class="mono">${formatPercent(parseFloat(payment.rate || 0) * 100)}</td>
                            <td class="mono">${formatNumber(parseFloat(payment.positionSize || 0))}</td>
                        </tr>
                    `;
                }).join('');
                
                document.getElementById('fundingTableBody').innerHTML = fundingHtml || '<tr><td colspan="5">No funding payments</td></tr>';
                document.getElementById('fundingReceived').textContent = formatCurrency(totalReceived);
                document.getElementById('fundingPaid').textContent = formatCurrency(totalPaid);
                document.getElementById('netFunding').textContent = formatCurrency(totalReceived - totalPaid);
                
                if (totalReceived - totalPaid > 0) {
                    document.getElementById('netFunding').classList.add('profit');
                } else if (totalReceived - totalPaid < 0) {
                    document.getElementById('netFunding').classList.add('loss');
                }
            }

            // Process historical P&L
            if (allData.historicalPnl?.historicalPnl) {
                const pnlData = allData.historicalPnl.historicalPnl;
                
                const pnlHtml = pnlData.slice(0, 30).map(day => `
                    <tr>
                        <td>${new Date(day.createdAt).toLocaleDateString()}</td>
                        <td class="mono">${formatCurrency(parseFloat(day.equity || 0))}</td>
                        <td class="mono ${parseFloat(day.totalPnl || 0) > 0 ? 'profit' : 'loss'}">${formatCurrency(parseFloat(day.totalPnl || 0))}</td>
                        <td class="mono">${formatCurrency(parseFloat(day.netTransfers || 0))}</td>
                    </tr>
                `).join('');
                
                document.getElementById('pnlTableBody').innerHTML = pnlHtml || '<tr><td colspan="4">No historical data</td></tr>';
            }
        }

        // Show/hide loading
        function showLoading(show) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
        }

        // Show error
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        // Hide error
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Check for address in URL on load
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const address = urlParams.get('address');
            
            if (address) {
                document.getElementById('addressInput').value = address;
                loadDashboard();
            }
        });

        // Enter key to load
        document.getElementById('addressInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadDashboard();
            }
        });
    </script>
</body>
</html>